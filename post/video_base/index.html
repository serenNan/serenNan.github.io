<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="‰∏Ä‰∫õÈü≥ËßÜÈ¢ëÁöÑÁü•ËØÜÁÇπ">
<title>Èü≥ËßÜÈ¢ëÂü∫Á°Ä</title>

<link rel='canonical' href='https://example.com/post/video_base/'>

<link rel="stylesheet" href="/scss/style.min.b8c49c4733adb64de1be8015622c503b3fad096cea290f68051eee4dce43e3da.css"><meta property='og:title' content="Èü≥ËßÜÈ¢ëÂü∫Á°Ä">
<meta property='og:description' content="‰∏Ä‰∫õÈü≥ËßÜÈ¢ëÁöÑÁü•ËØÜÁÇπ">
<meta property='og:url' content='https://example.com/post/video_base/'>
<meta property='og:site_name' content='serenNan'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-12-29T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2025-02-10T13:52:13&#43;08:00'/><meta property='og:image' content='https://example.com/post/video_base/player1.jpg' />
<meta name="twitter:title" content="Èü≥ËßÜÈ¢ëÂü∫Á°Ä">
<meta name="twitter:description" content="‰∏Ä‰∫õÈü≥ËßÜÈ¢ëÁöÑÁü•ËØÜÁÇπ"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://example.com/post/video_base/player1.jpg' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_47dcc2efc37d0778.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üêà‚Äç‚¨õ</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">serenNan</a></h1>
            <h2 class="site-description">‰∏™‰∫∫ÂçöÂÆ¢</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/450940909'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.0.0-beta2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M488.6 104.1C505.3 122.2 513 143.8 511.9 169.8V372.2C511.5 398.6 502.7 420.3 485.4 437.3C468.2 454.3 446.3 463.2 419.9 464H92.02C65.57 463.2 43.81 454.2 26.74 436.8C9.682 419.4 .7667 396.5 0 368.2V169.8C.7667 143.8 9.682 122.2 26.74 104.1C43.81 87.75 65.57 78.77 92.02 78H121.4L96.05 52.19C90.3 46.46 87.42 39.19 87.42 30.4C87.42 21.6 90.3 14.34 96.05 8.603C101.8 2.868 109.1 0 117.9 0C126.7 0 134 2.868 139.8 8.603L213.1 78H301.1L375.6 8.603C381.7 2.868 389.2 0 398 0C406.8 0 414.1 2.868 419.9 8.603C425.6 14.34 428.5 21.6 428.5 30.4C428.5 39.19 425.6 46.46 419.9 52.19L394.6 78L423.9 78C450.3 78.77 471.9 87.75 488.6 104.1H488.6zM449.8 173.8C449.4 164.2 446.1 156.4 439.1 150.3C433.9 144.2 425.1 140.9 416.4 140.5H96.05C86.46 140.9 78.6 144.2 72.47 150.3C66.33 156.4 63.07 164.2 62.69 173.8V368.2C62.69 377.4 65.95 385.2 72.47 391.7C78.99 398.2 86.85 401.5 96.05 401.5H416.4C425.6 401.5 433.4 398.2 439.7 391.7C446 385.2 449.4 377.4 449.8 368.2L449.8 173.8zM185.5 216.5C191.8 222.8 195.2 230.6 195.6 239.7V273C195.2 282.2 191.9 289.9 185.8 296.2C179.6 302.5 171.8 305.7 162.2 305.7C152.6 305.7 144.7 302.5 138.6 296.2C132.5 289.9 129.2 282.2 128.8 273V239.7C129.2 230.6 132.6 222.8 138.9 216.5C145.2 210.2 152.1 206.9 162.2 206.5C171.4 206.9 179.2 210.2 185.5 216.5H185.5zM377 216.5C383.3 222.8 386.7 230.6 387.1 239.7V273C386.7 282.2 383.4 289.9 377.3 296.2C371.2 302.5 363.3 305.7 353.7 305.7C344.1 305.7 336.3 302.5 330.1 296.2C323.1 289.9 320.7 282.2 320.4 273V239.7C320.7 230.6 324.1 222.8 330.4 216.5C336.7 210.2 344.5 206.9 353.7 206.5C362.9 206.9 370.7 210.2 377 216.5H377z"/></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/serenNan'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Generator: Adobe Illustrator 16.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="438.549px" height="438.549px" viewBox="0 0 438.549 438.549" style="enable-background:new 0 0 438.549 438.549;"
	 xml:space="preserve">
<g>
	<path d="M409.132,114.573c-19.608-33.596-46.205-60.194-79.798-79.8C295.736,15.166,259.057,5.365,219.271,5.365
		c-39.781,0-76.472,9.804-110.063,29.408c-33.596,19.605-60.192,46.204-79.8,79.8C9.803,148.168,0,184.854,0,224.63
		c0,47.78,13.94,90.745,41.827,128.906c27.884,38.164,63.906,64.572,108.063,79.227c5.14,0.954,8.945,0.283,11.419-1.996
		c2.475-2.282,3.711-5.14,3.711-8.562c0-0.571-0.049-5.708-0.144-15.417c-0.098-9.709-0.144-18.179-0.144-25.406l-6.567,1.136
		c-4.187,0.767-9.469,1.092-15.846,1c-6.374-0.089-12.991-0.757-19.842-1.999c-6.854-1.231-13.229-4.086-19.13-8.559
		c-5.898-4.473-10.085-10.328-12.56-17.556l-2.855-6.57c-1.903-4.374-4.899-9.233-8.992-14.559
		c-4.093-5.331-8.232-8.945-12.419-10.848l-1.999-1.431c-1.332-0.951-2.568-2.098-3.711-3.429c-1.142-1.331-1.997-2.663-2.568-3.997
		c-0.572-1.335-0.098-2.43,1.427-3.289c1.525-0.859,4.281-1.276,8.28-1.276l5.708,0.853c3.807,0.763,8.516,3.042,14.133,6.851
		c5.614,3.806,10.229,8.754,13.846,14.842c4.38,7.806,9.657,13.754,15.846,17.847c6.184,4.093,12.419,6.136,18.699,6.136
		c6.28,0,11.704-0.476,16.274-1.423c4.565-0.952,8.848-2.383,12.847-4.285c1.713-12.758,6.377-22.559,13.988-29.41
		c-10.848-1.14-20.601-2.857-29.264-5.14c-8.658-2.286-17.605-5.996-26.835-11.14c-9.235-5.137-16.896-11.516-22.985-19.126
		c-6.09-7.614-11.088-17.61-14.987-29.979c-3.901-12.374-5.852-26.648-5.852-42.826c0-23.035,7.52-42.637,22.557-58.817
		c-7.044-17.318-6.379-36.732,1.997-58.24c5.52-1.715,13.706-0.428,24.554,3.853c10.85,4.283,18.794,7.952,23.84,10.994
		c5.046,3.041,9.089,5.618,12.135,7.708c17.705-4.947,35.976-7.421,54.818-7.421s37.117,2.474,54.823,7.421l10.849-6.849
		c7.419-4.57,16.18-8.758,26.262-12.565c10.088-3.805,17.802-4.853,23.134-3.138c8.562,21.509,9.325,40.922,2.279,58.24
		c15.036,16.18,22.559,35.787,22.559,58.817c0,16.178-1.958,30.497-5.853,42.966c-3.9,12.471-8.941,22.457-15.125,29.979
		c-6.191,7.521-13.901,13.85-23.131,18.986c-9.232,5.14-18.182,8.85-26.84,11.136c-8.662,2.286-18.415,4.004-29.263,5.146
		c9.894,8.562,14.842,22.077,14.842,40.539v60.237c0,3.422,1.19,6.279,3.572,8.562c2.379,2.279,6.136,2.95,11.276,1.995
		c44.163-14.653,80.185-41.062,108.068-79.226c27.88-38.161,41.825-81.126,41.825-128.906
		C438.536,184.851,428.728,148.168,409.132,114.573z"/>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
<g>
</g>
</svg>

                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/category/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2"> <path d="M9 4h3l2 2h5a2 2 0 0 1 2 2v7a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-9a2 2 0 0 1 2 -2"></path> <path d="M17 17v2a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-9a2 2 0 0 1 2 -2h2"></path> </svg> 
                
                <span>ÂàÜÁ±ª</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>ÂΩíÊ°£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>ÊêúÁ¥¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>ÈìæÊé•</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
        <nav id="TableOfContents">
  <ol>
    <li><a href="#Âü∫Á°ÄÂëΩ‰ª§">Âü∫Á°ÄÂëΩ‰ª§</a></li>
    <li><a href="#Ëé∑ÂæóÂü∫Á°Ä‰ø°ÊÅØËæìÂá∫metadata">Ëé∑ÂæóÂü∫Á°Ä‰ø°ÊÅØÔºåËæìÂá∫Metadata</a>
      <ol>
        <li><a href="#‰ª£Á†Å">‰ª£Á†Å</a></li>
        <li><a href="#ÈáçË¶ÅÁªìÊûÑ‰Ωì">ÈáçË¶ÅÁªìÊûÑ‰Ωì</a></li>
      </ol>
    </li>
    <li><a href="#Ëß£Â∞ÅË£Ö-ÊèêÂèñaacÊï∞ÊçÆ">Ëß£Â∞ÅË£Ö-ÊèêÂèñaacÊï∞ÊçÆ</a>
      <ol>
        <li><a href="#ÊµÅÁ®ã">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-1">‰ª£Á†Å</a></li>
        <li><a href="#aacÈü≥È¢ëÊ†ºÂºèÂàÜÊûê">aacÈü≥È¢ëÊ†ºÂºèÂàÜÊûê</a>
          <ol>
            <li><a href="#adtsaudio-data-transport-stream">ADTSÔºàAudio Data Transport StreamÔºâ</a></li>
            <li><a href="#adifaudio-data-interchange-format">ADIFÔºàAudio Data Interchange FormatÔºâ</a></li>
            <li><a href="#ÊÄªÁªì">ÊÄªÁªì</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#ÊèêÂèñh264ËßÜÈ¢ëÊï∞ÊçÆ">ÊèêÂèñH264ËßÜÈ¢ëÊï∞ÊçÆ</a>
      <ol>
        <li><a href="#ÊµÅÁ®ã-1">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-2">‰ª£Á†Å</a></li>
      </ol>
    </li>
    <li><a href="#mp4h264">mp4‚Üíh264</a>
      <ol>
        <li><a href="#ÊµÅÁ®ã-2">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-3">‰ª£Á†Å</a></li>
      </ol>
    </li>
    <li><a href="#ËΩ¨Â∞ÅË£Ö-mp4ËΩ¨flv">ËΩ¨Â∞ÅË£Ö-mp4ËΩ¨flv</a>
      <ol>
        <li><a href="#iÂ∏ßpÂ∏ßbÂ∏ß">IÂ∏ßÔºåPÂ∏ßÔºåBÂ∏ß</a></li>
        <li><a href="#ÊµÅÁ®ã-3">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-4">‰ª£Á†Å</a></li>
      </ol>
    </li>
    <li><a href="#Êà™ÂèñÂ∞ÅË£ÖÊñá‰ª∂">Êà™ÂèñÂ∞ÅË£ÖÊñá‰ª∂</a>
      <ol>
        <li><a href="#Êó∂Èó¥Âü∫‰∏éÊó∂Èó¥Êà≥">Êó∂Èó¥Âü∫‰∏éÊó∂Èó¥Êà≥</a></li>
        <li><a href="#ÊµÅÁ®ã-4">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-5">‰ª£Á†Å</a></li>
      </ol>
    </li>
    <li><a href="#ËßÜÈ¢ëËß£Á†Å">ËßÜÈ¢ëËß£Á†Å</a>
      <ol>
        <li><a href="#rgb‰ªãÁªç">RGB‰ªãÁªç</a>
          <ol>
            <li><a href="#rgbÊ†ºÂºè">RGBÊ†ºÂºè</a></li>
          </ol>
        </li>
        <li><a href="#yuv‰ªãÁªç">YUV‰ªãÁªç</a></li>
        <li><a href="#ÊµÅÁ®ã-5">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-6">‰ª£Á†Å</a></li>
      </ol>
    </li>
    <li><a href="#Êõ¥ÊîπËßÜÈ¢ëÊ†ºÂºè">Êõ¥ÊîπËßÜÈ¢ëÊ†ºÂºè</a>
      <ol>
        <li><a href="#ÊµÅÁ®ã-6">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-7">‰ª£Á†Å</a></li>
        <li><a href="#Ëß£Á†ÅÂêéÁöÑÊï∞ÊçÆÂ≠òÂÇ®">Ëß£Á†ÅÂêéÁöÑÊï∞ÊçÆÂ≠òÂÇ®</a></li>
        <li><a href="#ÂÜÖÂ≠òÂØπÈΩêÂíå-linesize">ÂÜÖÂ≠òÂØπÈΩêÂíå <code>linesize</code></a></li>
        <li><a href="#sws_scale-ÂáΩÊï∞ÂäüËÉΩ"><code>sws_scale</code> ÂáΩÊï∞ÂäüËÉΩ</a></li>
        <li><a href="#bmpÊñá‰ª∂Ê†ºÂºè">BMPÊñá‰ª∂Ê†ºÂºè</a></li>
      </ol>
    </li>
    <li><a href="#ËßÜÈ¢ëÁºñÁ†ÅyuvÂà∞h264">ËßÜÈ¢ëÁºñÁ†ÅÔºàyuvÂà∞h264Ôºâ</a>
      <ol>
        <li><a href="#ÊµÅÁ®ã-7">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-8">‰ª£Á†Å</a></li>
      </ol>
    </li>
    <li><a href="#Èü≥È¢ëËß£Á†Å">Èü≥È¢ëËß£Á†Å</a>
      <ol>
        <li><a href="#pcm‰ªãÁªç">PCM‰ªãÁªç</a>
          <ol>
            <li><a href="#pcmÂÖ≥ÈîÆË¶ÅÁ¥†">PCMÂÖ≥ÈîÆË¶ÅÁ¥†</a></li>
            <li><a href="#pcmÊï∞ÊçÆÊ†ºÂºè">PCMÊï∞ÊçÆÊ†ºÂºè</a></li>
            <li><a href="#pcmËÆ°ÁÆó">PCMËÆ°ÁÆó</a></li>
          </ol>
        </li>
        <li><a href="#ÊµÅÁ®ã-8">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-9">‰ª£Á†Å</a></li>
      </ol>
    </li>
    <li><a href="#Èü≥È¢ëÁºñÁ†Å">Èü≥È¢ëÁºñÁ†Å</a>
      <ol>
        <li><a href="#ÊµÅÁ®ã-9">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-10">‰ª£Á†Å</a></li>
      </ol>
    </li>
    <li><a href="#ËßÜÈ¢ëÈááÈõÜ">ËßÜÈ¢ëÈááÈõÜ</a>
      <ol>
        <li><a href="#ËßÜÈ¢ëÈááÈõÜÂëΩ‰ª§">ËßÜÈ¢ëÈááÈõÜÂëΩ‰ª§</a></li>
        <li><a href="#ÊµÅÁ®ã-10">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-11">‰ª£Á†Å</a></li>
      </ol>
    </li>
    <li><a href="#Èü≥È¢ëÈááÈõÜ">Èü≥È¢ëÈááÈõÜ</a>
      <ol>
        <li><a href="#Èü≥È¢ëÈááÈõÜÂëΩ‰ª§">Èü≥È¢ëÈááÈõÜÂëΩ‰ª§</a></li>
        <li><a href="#ÊµÅÁ®ã-11">ÊµÅÁ®ã</a></li>
        <li><a href="#‰ª£Á†Å-12">‰ª£Á†Å</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>


<script>
    function initTocHide() {
        
        let toc = document.querySelector(".widget--toc");
        if (!toc) {
            return;
        }
        
        window.addEventListener('scroll', function() {
            
            let currentLi = document.querySelector(".active-class");
            if (!currentLi) {
                return
            }
            
            let elementsByClassName = document.querySelectorAll(".open");
            if (elementsByClassName.length > 0) {
                elementsByClassName.forEach((ul) => {
                    ul.classList.remove("open")
                })
            }
            
            if (currentLi.children.length > 1) {
                currentLi.children[1].classList.add("open")
            }
            
            let ul = currentLi.parentElement;
            do {
                ul.classList.add("open");
                ul = ul.parentElement.parentElement
            } while (ul !== undefined && (ul.localName === 'ul' || ul.localName === 'ol'))
        });
    }
    initTocHide()
</script>
            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/post/video_base/">
                <img src="/post/video_base/player1.jpg"
                        
                        width="3200" 
                        height="2400" 
                        loading="lazy"
                        alt="Featured image of post Èü≥ËßÜÈ¢ëÂü∫Á°Ä" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/video/" style="background-color: #8464C6; color: #fff;">
                Video
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/video_base/">Èü≥ËßÜÈ¢ëÂü∫Á°Ä</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            ‰∏Ä‰∫õÈü≥ËßÜÈ¢ëÁöÑÁü•ËØÜÁÇπ
        </h3>
        
    </div>

    
    
    
    

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-12-29</time>
            </div>
        

        

        
                <span class="time-divider">|</span>
            <div class="article-time--lastmod">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" width="24" height="24" stroke-width="2"> <path d="M8 5h-2a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h5.697"></path> <path d="M18 14v4h4"></path> <path d="M18 11v-4a2 2 0 0 0 -2 -2h-2"></path> <path d="M8 3m0 2a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v0a2 2 0 0 1 -2 2h-2a2 2 0 0 1 -2 -2z"></path> <path d="M18 18m-4 0a4 4 0 1 0 8 0a4 4 0 1 0 -8 0"></path> <path d="M8 11h4"></path> <path d="M8 15h3"></path> </svg> 
                <time>
                    2025-02-10 13:52
                </time>
            </div></footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="Âü∫Á°ÄÂëΩ‰ª§">Âü∫Á°ÄÂëΩ‰ª§
</h2><p><a class="link" href="https://blog.csdn.net/wenmingzheng/article/details/88373192?ops_request_misc=%257B%2522request%255Fid%2522%253A%25228EA3F7CC-D940-48CA-A46F-A57216709319%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=8EA3F7CC-D940-48CA-A46F-A57216709319&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-88373192-null-null.142%5ev100%5epc_search_result_base1&amp;utm_term=ffmpeg%E5%91%BD%E4%BB%A4&amp;spm=1018.2226.3001.4187"  target="_blank" rel="noopener"
    >CSDNÂçö‰∏ªÊÄªÁªìÂ∏∏Áî®ÂëΩ‰ª§</a></p>
<h2 id="Ëé∑ÂæóÂü∫Á°Ä‰ø°ÊÅØËæìÂá∫metadata">Ëé∑ÂæóÂü∫Á°Ä‰ø°ÊÅØÔºåËæìÂá∫Metadata
</h2><p>ÊâìÂºÄÂ™í‰ΩìÊñá‰ª∂ÔºåËé∑ÂèñMeta‰ø°ÊÅØÔºåÂÖ≥Èó≠Â™í‰ΩìÊñá‰ª∂</p>
<h3 id="‰ª£Á†Å">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/log.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavformat/avformat.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ‰º†ÂÖ•ÂëΩ‰ª§Ë°åÂèÇÊï∞‰∏™Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ËÆæÁΩÆÊó•ÂøóÁ∫ßÂà´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_DEBUG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ËÆæÁΩÆÊó•ÂøóËæìÂá∫ÂáΩÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Ê£ÄÊü•ÂèÇÊï∞‰∏™Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_DEBUG</span><span class="p">,</span> <span class="s">&#34;Usage:%s infileName.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ëé∑ÂèñËæìÂÖ•Êñá‰ª∂Âêç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">infileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ÂàùÂßãÂåñÊâÄÊúâÁªÑ‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">pFormatCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ÊâìÂºÄÂ™í‰ΩìÊñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pFormatCtx</span><span class="p">,</span> <span class="n">infileName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// av_err2str()ÂáΩÊï∞ËøîÂõûÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// av_err2str()ÂáΩÊï∞ËøîÂõûÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_DEBUG</span><span class="p">,</span> <span class="s">&#34;open input file:%s failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">infileName</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ëé∑ÂèñÂ™í‰ΩìÊñá‰ª∂‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">av_dump_format</span><span class="p">(</span><span class="n">pFormatCtx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">infileName</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// ÂÖ≥Èó≠Â™í‰ΩìÊñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pFormatCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>ÂÆπÂô®/Êñá‰ª∂ (Container/File)</li>
</ol>
<ul>
<li><strong>ÂÆö‰πâ</strong>: ÁâπÂÆöÊ†ºÂºèÁöÑÂ§öÂ™í‰ΩìÊñá‰ª∂ÔºåÂ¶Ç¬†<code>.mp4</code>,¬†<code>.flv</code>,¬†<code>.mov</code>¬†Á≠â„ÄÇ</li>
<li><strong>‰ΩúÁî®</strong>: Â≠òÂÇ®ÂíåÁªÑÁªáÂ§öÂ™í‰ΩìÊï∞ÊçÆÔºåÂåÖÊã¨Èü≥È¢ë„ÄÅËßÜÈ¢ë„ÄÅÂ≠óÂπïÁ≠â„ÄÇ</li>
<li><strong>Â∏∏ËßÅÊ†ºÂºè</strong>:
<ul>
<li><strong>MP4</strong>: ÂπøÊ≥õÁî®‰∫éËßÜÈ¢ëÂ≠òÂÇ®ÂíåÊµÅÂ™í‰Ωì„ÄÇ</li>
<li><strong>FLV</strong>: ‰∏ªË¶ÅÁî®‰∫éFlashËßÜÈ¢ë„ÄÇ</li>
<li><strong>MOV</strong>: ËãπÊûúÂÖ¨Âè∏ÂºÄÂèëÁöÑËßÜÈ¢ëÊ†ºÂºè„ÄÇ</li>
</ul>
</li>
</ul>
<ol start="2">
<li>Â™í‰ΩìÊµÅ (Stream)</li>
</ol>
<ul>
<li><strong>ÂÆö‰πâ</strong>: ‰∏ÄÊÆµËøûÁª≠ÁöÑÊï∞ÊçÆÔºåÂ¶Ç‰∏ÄÊÆµÂ£∞Èü≥Êï∞ÊçÆ„ÄÅ‰∏ÄÊÆµËßÜÈ¢ëÊàñËÄÖ‰∏ÄÊÆµÂ≠óÂπïÊï∞ÊçÆ„ÄÇ</li>
<li><strong>ÁâπÁÇπ</strong>: Áî±‰∏çÂêåÁºñÁ†ÅÂô®ÁºñÁ†Å„ÄÇ</li>
<li><strong>Á±ªÂûã</strong>:
<ul>
<li><strong>Èü≥È¢ëÊµÅ</strong>: Â≠òÂÇ®Èü≥È¢ëÊï∞ÊçÆ„ÄÇ</li>
<li><strong>ËßÜÈ¢ëÊµÅ</strong>: Â≠òÂÇ®ËßÜÈ¢ëÊï∞ÊçÆ„ÄÇ</li>
<li><strong>Â≠óÂπïÊµÅ</strong>: Â≠òÂÇ®Â≠óÂπïÊï∞ÊçÆ„ÄÇ</li>
</ul>
</li>
</ul>
<ol start="3">
<li>Êï∞ÊçÆÂåÖ (Packet)</li>
</ol>
<ul>
<li><strong>ÂÆö‰πâ</strong>: ‰∏Ä‰∏™Â™í‰ΩìÊµÅÁî±Â§ßÈáèÁöÑÊï∞ÊçÆÂåÖÁªÑÊàêÔºåÊòØÂéãÁº©ÂêéÁöÑÊï∞ÊçÆ„ÄÇ</li>
<li><strong>‰ΩúÁî®</strong>: ‰º†ËæìÂíåÂ≠òÂÇ®Â™í‰ΩìÊï∞ÊçÆÁöÑÂü∫Êú¨Âçï‰Ωç„ÄÇ</li>
<li><strong>ÁâπÁÇπ</strong>: Êï∞ÊçÆÂåÖÊòØÂéãÁº©ÂêéÁöÑÊï∞ÊçÆÔºå‰æø‰∫é‰º†ËæìÂíåÂ≠òÂÇ®„ÄÇ</li>
</ul>
<ol start="4">
<li>Êï∞ÊçÆÂ∏ß (Frame)</li>
</ol>
<ul>
<li><strong>ÂÆö‰πâ</strong>: ‰∏Ä‰∏™Êï∞ÊçÆÂåÖÁî±‰∏Ä‰∏™ÊàñÂ§ö‰∏™Êï∞ÊçÆÂ∏ßÁªÑÊàêÔºåÊòØÈùûÂéãÁº©Êï∞ÊçÆ„ÄÇ</li>
<li><strong>‰ΩúÁî®</strong>: ÂéüÂßãÁöÑ„ÄÅÊú™ÂéãÁº©ÁöÑÂ™í‰ΩìÊï∞ÊçÆ„ÄÇ</li>
<li><strong>Á±ªÂûã</strong>:
<ul>
<li><strong>IÂ∏ß (Intra Frame)</strong>: Áã¨Á´ãÂ∏ßÔºå‰∏ç‰æùËµñÂÖ∂‰ªñÂ∏ß„ÄÇ</li>
<li><strong>PÂ∏ß (Predictive Frame)</strong>: ‰æùËµñÂâç‰∏ÄÂ∏ßËøõË°åÈ¢ÑÊµã„ÄÇ</li>
<li><strong>BÂ∏ß (Bidirectional Frame)</strong>: ‰æùËµñÂâçÂêéÂ∏ßËøõË°åÈ¢ÑÊµã„ÄÇ</li>
</ul>
</li>
</ul>
<ol start="5">
<li>ÁºñËß£Á†ÅÂô® (Codec)</li>
</ol>
<ul>
<li><strong>ÂÆö‰πâ</strong>: ÁºñËß£Á†ÅÂô®ÊòØ‰ª•Â∏ß‰∏∫Âçï‰ΩçÂÆûÁé∞ÂéãÁº©Êï∞ÊçÆÂíåÂéüÂßãÊï∞ÊçÆ‰πãÈó¥Áõ∏‰∫íËΩ¨Êç¢ÁöÑÂ∑•ÂÖ∑„ÄÇ</li>
<li><strong>‰ΩúÁî®</strong>: Áî®‰∫éÂéãÁº©ÂíåËß£ÂéãÁº©Â™í‰ΩìÊï∞ÊçÆ„ÄÇ</li>
<li><strong>Â∏∏ËßÅÁºñËß£Á†ÅÂô®</strong>:
<ul>
<li><strong>ËßÜÈ¢ëÁºñËß£Á†ÅÂô®</strong>: H.264, H.265, VP9 Á≠â„ÄÇ</li>
<li><strong>Èü≥È¢ëÁºñËß£Á†ÅÂô®</strong>: AAC, MP3, Vorbis Á≠â„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="ÈáçË¶ÅÁªìÊûÑ‰Ωì">ÈáçË¶ÅÁªìÊûÑ‰Ωì
</h3><ul>
<li><strong>AVFormatContext</strong>: ÁÆ°ÁêÜÊï¥‰∏™Â§öÂ™í‰ΩìÊñá‰ª∂ÁöÑÊ†ºÂºèÂíåÁªìÊûÑ„ÄÇ</li>
<li><strong>AVStream</strong>: Ë°®Á§∫Â™í‰ΩìÊñá‰ª∂‰∏≠ÁöÑ‰∏Ä‰∏™ÂçïÁã¨ÁöÑÂ™í‰ΩìÊµÅ„ÄÇ</li>
<li><strong>AVCodecContext ‰∏é AVCodec</strong>: ÁÆ°ÁêÜÂ™í‰ΩìÊï∞ÊçÆÁöÑÁºñÁ†ÅÂíåËß£Á†ÅËøáÁ®ã„ÄÇ</li>
<li><strong>AVPacket</strong>: Ë°®Á§∫ÂéãÁº©ÂêéÁöÑÂ™í‰ΩìÊï∞ÊçÆ„ÄÇ</li>
<li><strong>AVFrame</strong>: Ë°®Á§∫Êú™ÂéãÁº©ÁöÑÂéüÂßãÂ™í‰ΩìÊï∞ÊçÆ„ÄÇ</li>
</ul>
<h2 id="Ëß£Â∞ÅË£Ö-ÊèêÂèñaacÊï∞ÊçÆ">Ëß£Â∞ÅË£Ö-ÊèêÂèñaacÊï∞ÊçÆ
</h2><p>AACÔºàAdvanced Audio CodingÔºâÊòØ‰∏ÄÁßçÈ´òÁ∫ßÈü≥È¢ëÁºñÁ†ÅÊäÄÊúØÔºåÂπøÊ≥õÁî®‰∫éÊï∞Â≠óÈü≥È¢ëÂéãÁº©Âíå‰º†Ëæì„ÄÇÂÆÉÊòØÁî±MPEGÔºàMoving Picture Experts GroupÔºâÂºÄÂèëÁöÑÔºåÊó®Âú®Êèê‰æõÊØîMP3Êõ¥È´òÁöÑÈü≥Ë¥®ÂíåÊõ¥È´òÁöÑÂéãÁº©ÊïàÁéá„ÄÇAACÈÄöÂ∏∏Áî®‰∫éÂêÑÁßçÈü≥È¢ëÂ∫îÁî®ÔºåÂåÖÊã¨Èü≥‰πê„ÄÅËßÜÈ¢ë„ÄÅÂπøÊí≠ÂíåÊµÅÂ™í‰ΩìÊúçÂä°„ÄÇ</p>
<p><strong>AACÁöÑ‰∏ªË¶ÅÁâπÁÇπÔºö</strong></p>
<ol>
<li><strong>È´òÈü≥Ë¥®</strong>ÔºöAACËÉΩÂ§üÂú®ËæÉ‰ΩéÁöÑÊØîÁâπÁéá‰∏ãÊèê‰æõÊØîMP3Êõ¥È´òÁöÑÈü≥Ë¥®„ÄÇ</li>
<li><strong>Â§öÈÄöÈÅìÊîØÊåÅ</strong>ÔºöAACÊîØÊåÅÂ§öÈÄöÈÅìÈü≥È¢ëÔºåÂåÖÊã¨Á´ã‰ΩìÂ£∞„ÄÅ5.1ÁéØÁªïÂ£∞Âíå7.1ÁéØÁªïÂ£∞„ÄÇ</li>
<li><strong>‰ΩéÂª∂Ëøü</strong>ÔºöAACËÆæËÆ°Áî®‰∫é‰ΩéÂª∂ËøüÂ∫îÁî®ÔºåÈÄÇÂêàÂÆûÊó∂Èü≥È¢ë‰º†Ëæì„ÄÇ</li>
<li><strong>ÁÅµÊ¥ªÊÄß</strong>ÔºöAACÊîØÊåÅÂ§öÁßçÊØîÁâπÁéáÂíåÈááÊ†∑ÁéáÔºåÈÄÇÁî®‰∫é‰∏çÂêåÁöÑÂ∫îÁî®Âú∫ÊôØ„ÄÇ</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffmpeg -y -i out.mp4 -vn -acodec copy out.aac
</span></span><span class="line"><span class="cl">ffplay out.aac
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ÊµÅÁ®ã">ÊµÅÁ®ã
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Êìç‰ΩúÊ≠•È™§</th>
          <th>ÂáΩÊï∞Âêç</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ÊâìÂºÄÂ™í‰ΩìÊñá‰ª∂</td>
          <td><code>avformat_open_input</code></td>
      </tr>
      <tr>
          <td>Ëé∑ÂèñÁ†ÅÊµÅ‰ø°ÊÅØ</td>
          <td><code>avformat_find_stream_info</code></td>
      </tr>
      <tr>
          <td>Ëé∑ÂèñÈü≥È¢ëÊµÅ</td>
          <td><code>av_find_best_stream</code></td>
      </tr>
      <tr>
          <td>ÂàùÂßãÂåñ packet</td>
          <td><code>av_packet_alloc</code></td>
      </tr>
      <tr>
          <td>ËØªÂèñ packet Êï∞ÊçÆ</td>
          <td><code>av_read_frame</code></td>
      </tr>
      <tr>
          <td>ÈáäÊîæ packet Êï∞ÊçÆ</td>
          <td><code>av_packet_unref</code></td>
      </tr>
      <tr>
          <td>ÂÖ≥Èó≠Â™í‰ΩìÊñá‰ª∂</td>
          <td><code>avformat_close_input</code></td>
      </tr>
  </tbody>
</table></div>
<h3 id="‰ª£Á†Å-1">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/avutil.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavformat/avformat.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆÊó•ÂøóÁ∫ßÂà´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_DEBUG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÂèÇÊï∞Â∞è‰∫é3ÔºåËæìÂá∫‰ΩøÁî®ÊñπÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// argv[0]ÊòØÁ®ãÂ∫èÂêç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage: %s &lt;input file&gt; &lt;output file&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÂëΩ‰ª§Ë°åÁöÑËæìÂÖ•Èü≥È¢ë
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inputName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÂëΩ‰ª§Ë°åÁöÑËæìÂá∫Èü≥È¢ë
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outputName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">av_sdp_create</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊâìÂºÄËæìÂÖ•Èü≥È¢ëÊñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFormatCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊâìÂºÄÂ™í‰ΩìÊñá‰ª∂ÔºåÂπ∂Ëé∑ÂèñÊµÅ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFormatCtx</span><span class="p">,</span> <span class="n">inputName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÊâìÂºÄËæìÂÖ•Êñá‰ª∂Â§±Ë¥•ÔºåËøîÂõûÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not open input file &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">inputName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÁ†ÅÊµÅ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_find_stream_info</span><span class="p">(</span><span class="n">inFormatCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúretÂ∞è‰∫é0ÔºåÂàôÊâìÂç∞ÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find stream info failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â∞±ÁÆóËé∑ÂèñÂ§±Ë¥•Ôºå‰πüË¶ÅÂÖ≥Èó≠ËæìÂÖ•Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFormatCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúËé∑ÂèñÊàêÂäüÔºåÂàôÊâìÂç∞‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">audioIndex</span> <span class="o">=</span> <span class="nf">av_find_best_stream</span><span class="p">(</span><span class="n">inFormatCtx</span><span class="p">,</span> <span class="n">AVMEDIA_TYPE_AUDIO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">audioIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not find audio stream in the input file</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFormatCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">audioIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ËæìÂá∫ÈîôËØØ‰ø°ÊÅØÔºåË°®Á§∫Êâæ‰∏çÂà∞ÊúÄ‰Ω≥Èü≥È¢ëÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find best stream failed, index is %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">audioIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFormatCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊâìÂç∞Èü≥È¢ë‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_INFO</span><span class="p">,</span> <span class="s">&#34;the audio index is %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">audioIndex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàùÂßãÂåñAVPacketÁªìÊûÑ‰Ωì
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not allocate packet</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFormatCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â≠òÂÇ®Èü≥È¢ëÊµÅ‰ø°ÊÅØ ËæìÂá∫Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">outputName</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open %s file failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">outputName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â∞±ÁÆóÊâì‰∏çÂºÄÊñá‰ª∂‰πüÂæóÂÖ≥Èó≠Èü≥È¢ëÊñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFormatCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ÈáäÊîæÂàÜÈÖçÁöÑAVPacket
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_packet_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊúâËÆ∏Â§öPCÊï∞ÊçÆÔºåÊâÄ‰ª•ÈúÄË¶ÅÂæ™ÁéØËØªÂèñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nf">av_read_frame</span><span class="p">(</span><span class="n">inFormatCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Ê£ÄÊü•ÂΩìÂâçÂåÖÊòØÂê¶Â±û‰∫éÈü≥È¢ëÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">audioIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Â∞ÜÈü≥È¢ëÊï∞ÊçÆÂÜôÂÖ•ËæìÂá∫Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">fwrite</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Ê£ÄÊü•ÂÜôÂÖ•ÊòØÂê¶ÊàêÂäü
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// Â¶ÇÊûúÂÜôÂÖ•ÁöÑÊï∞ÊçÆÂ§ßÂ∞è‰∏çÁ≠â‰∫éÂåÖÁöÑÂ§ßÂ∞èÔºåÂàôËæìÂá∫ÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;write data failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ÂÖ≥Èó≠ËæìÂá∫Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ÂÖ≥Èó≠ËæìÂÖ•Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFormatCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ÈáäÊîæÊï¥‰∏™ÁªìÊûÑ‰Ωì
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">av_packet_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ÈáäÊîæÂΩìÂâçÂåÖÁöÑÂºïÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•ËæìÂÖ•Ê†ºÂºè‰∏ä‰∏ãÊñáÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">inFormatCtx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ÂÖ≥Èó≠ËæìÂÖ•Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFormatCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•ËæìÂá∫Êñá‰ª∂ÊåáÈíàÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ÂÖ≥Èó≠ËæìÂá∫Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ÈáäÊîæAVPacketÁªìÊûÑ‰Ωì
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_packet_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="aacÈü≥È¢ëÊ†ºÂºèÂàÜÊûê">aacÈü≥È¢ëÊ†ºÂºèÂàÜÊûê
</h3><p>ADTSÔºàAudio Data Transport StreamÔºâÂíåADIFÔºàAudio Data Interchange FormatÔºâÊòØ‰∏§ÁßçÁî®‰∫éÈü≥È¢ëÁºñÁ†ÅÁöÑÂÆπÂô®Ê†ºÂºèÔºå‰∏ªË¶ÅÁî®‰∫éAACÔºàAdvanced Audio CodecÔºâÈü≥È¢ëÁºñÁ†Å„ÄÇÂÆÉ‰ª¨ÁöÑ‰∏ªË¶ÅÂå∫Âà´Âú®‰∫éÊï∞ÊçÆÊµÅÁöÑÁªÑÁªáÊñπÂºèÂíå‰ΩøÁî®Âú∫ÊôØ„ÄÇ</p>
<h4 id="adtsaudio-data-transport-stream">ADTSÔºàAudio Data Transport StreamÔºâ
</h4><ul>
<li><strong>ÂÆö‰πâ</strong>: ADTSÊòØ‰∏ÄÁßçÊµÅÂºè‰º†ËæìÊ†ºÂºèÔºåÈÄÇÁî®‰∫éÈü≥È¢ëÊï∞ÊçÆÁöÑÂÆûÊó∂‰º†ËæìÔºåÂ¶ÇÂπøÊí≠„ÄÅÊµÅÂ™í‰ΩìÁ≠â„ÄÇ</li>
<li><strong>ÁªìÊûÑ</strong>: ÊØè‰∏™ADTSÂ∏ßÈÉΩÂåÖÂê´‰∏Ä‰∏™Â§¥‰ø°ÊÅØÔºåÂêéÈù¢Ë∑üÁùÄÈü≥È¢ëÊï∞ÊçÆ„ÄÇÂ§¥‰ø°ÊÅØ‰∏≠ÂåÖÂê´‰∫ÜÂ∏ßÁöÑÈïøÂ∫¶„ÄÅÈááÊ†∑Áéá„ÄÅÂ£∞ÈÅìÊï∞Á≠â‰ø°ÊÅØ„ÄÇ</li>
<li><strong>ÁâπÁÇπ</strong>:
<ul>
<li><strong>Ëá™ÂåÖÂê´</strong>: ÊØè‰∏™ADTSÂ∏ßÈÉΩÊòØËá™ÂåÖÂê´ÁöÑÔºåÂèØ‰ª•Áã¨Á´ãËß£Á†Å„ÄÇ</li>
<li><strong>ÊµÅÂºè‰º†Ëæì</strong>: ÈÄÇÂêàÊµÅÂºè‰º†ËæìÔºåÂõ†‰∏∫ÊØè‰∏™Â∏ßÈÉΩÂèØ‰ª•Áã¨Á´ãÂ§ÑÁêÜ„ÄÇ</li>
<li><strong>Â§¥ÈÉ®‰ø°ÊÅØ</strong>: ÊØè‰∏™Â∏ßÁöÑÂ§¥ÈÉ®‰ø°ÊÅØËæÉÂ§ßÔºåÂèØËÉΩ‰ºöÂ¢ûÂä†‰∏Ä‰∫õÂºÄÈîÄ„ÄÇ</li>
</ul>
</li>
</ul>
<h4 id="adifaudio-data-interchange-format">ADIFÔºàAudio Data Interchange FormatÔºâ
</h4><ul>
<li><strong>ÂÆö‰πâ</strong>: ADIFÊòØ‰∏ÄÁßçÊñá‰ª∂Ê†ºÂºèÔºåÈÄÇÁî®‰∫éÈü≥È¢ëÊï∞ÊçÆÁöÑÂ≠òÂÇ®Âíå‰∫§Êç¢ÔºåÂ¶ÇÈü≥È¢ëÊñá‰ª∂ÁöÑÂ≠òÂÇ®„ÄÇ</li>
<li><strong>ÁªìÊûÑ</strong>: ADIFÊñá‰ª∂ÂåÖÂê´‰∏Ä‰∏™ÂîØ‰∏ÄÁöÑÂ§¥‰ø°ÊÅØÔºåÂêéÈù¢Ë∑üÁùÄÊâÄÊúâÁöÑÈü≥È¢ëÊï∞ÊçÆ„ÄÇÂ§¥‰ø°ÊÅØ‰∏≠ÂåÖÂê´‰∫ÜÁºñÁ†ÅÂèÇÊï∞„ÄÅÈááÊ†∑Áéá„ÄÅÂ£∞ÈÅìÊï∞Á≠â‰ø°ÊÅØ„ÄÇ</li>
<li><strong>ÁâπÁÇπ</strong>:
<ul>
<li><strong>Âçï‰∏ÄÂ§¥ÈÉ®</strong>: Êï¥‰∏™Êñá‰ª∂Âè™Êúâ‰∏Ä‰∏™Â§¥ÈÉ®‰ø°ÊÅØÔºåÂáèÂ∞ë‰∫ÜÂÜó‰Ωô„ÄÇ</li>
<li><strong>ÈùûÊµÅÂºè</strong>: ‰∏çÈÄÇÂêàÊµÅÂºè‰º†ËæìÔºåÂõ†‰∏∫ÈúÄË¶ÅÊï¥‰∏™Êñá‰ª∂ÁöÑÂ§¥‰ø°ÊÅØÊâçËÉΩÂºÄÂßãËß£Á†Å„ÄÇ</li>
<li><strong>Â≠òÂÇ®Âíå‰∫§Êç¢</strong>: ÈÄÇÂêàÂ≠òÂÇ®Âíå‰∫§Êç¢Èü≥È¢ëÊï∞ÊçÆÔºåÂõ†‰∏∫Â§¥ÈÉ®‰ø°ÊÅØÂè™Âá∫Áé∞‰∏ÄÊ¨°ÔºåÂáèÂ∞ë‰∫ÜÊñá‰ª∂Â§ßÂ∞è„ÄÇ</li>
</ul>
</li>
</ul>
<h4 id="ÊÄªÁªì">ÊÄªÁªì
</h4><ul>
<li><strong>ADTS</strong>: ÈÄÇÁî®‰∫éÊµÅÂºè‰º†ËæìÔºåÊØè‰∏™Â∏ßËá™ÂåÖÂê´ÔºåÈÄÇÂêàÂÆûÊó∂‰º†Ëæì„ÄÇ</li>
<li><strong>ADIF</strong>: ÈÄÇÁî®‰∫éÊñá‰ª∂Â≠òÂÇ®Âíå‰∫§Êç¢ÔºåÊï¥‰∏™Êñá‰ª∂Âè™Êúâ‰∏Ä‰∏™Â§¥ÈÉ®‰ø°ÊÅØÔºåÈÄÇÂêàÂ≠òÂÇ®Âíå‰∫§Êç¢Èü≥È¢ëÊï∞ÊçÆ„ÄÇ</li>
</ul>
<p>ÈÄâÊã©Âì™ÁßçÊ†ºÂºèÂèñÂÜ≥‰∫éÂÖ∑‰ΩìÁöÑÂ∫îÁî®Âú∫ÊôØÔºöÂ¶ÇÊûúÈúÄË¶ÅÂÆûÊó∂‰º†ËæìÈü≥È¢ëÊï∞ÊçÆÔºåADTSÊòØÊõ¥Â•ΩÁöÑÈÄâÊã©ÔºõÂ¶ÇÊûúÈúÄË¶ÅÂ≠òÂÇ®Êàñ‰∫§Êç¢Èü≥È¢ëÊñá‰ª∂ÔºåADIFÊõ¥‰∏∫ÂêàÈÄÇ„ÄÇ</p>
<h2 id="ÊèêÂèñh264ËßÜÈ¢ëÊï∞ÊçÆ">ÊèêÂèñH264ËßÜÈ¢ëÊï∞ÊçÆ
</h2><h3 id="ÊµÅÁ®ã-1">ÊµÅÁ®ã
</h3><p>ÊµÅÁ®ãÂíåÊèêÂèñaacÊñá‰ª∂‰∏ÄÊ†∑</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Êìç‰ΩúÊ≠•È™§</th>
          <th>ÂáΩÊï∞Âêç</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ÊâìÂºÄÂ™í‰ΩìÊñá‰ª∂</td>
          <td><code>avformat_open_input</code></td>
      </tr>
      <tr>
          <td>Ëé∑ÂèñÁ†ÅÊµÅ‰ø°ÊÅØ</td>
          <td><code>avformat_find_stream_info</code></td>
      </tr>
      <tr>
          <td>Ëé∑ÂèñÈü≥È¢ëÊµÅ</td>
          <td><code>av_find_best_stream</code></td>
      </tr>
      <tr>
          <td>ÂàùÂßãÂåñ packet</td>
          <td><code>av_packet_alloc</code></td>
      </tr>
      <tr>
          <td>ËØªÂèñ packet Êï∞ÊçÆ</td>
          <td><code>av_read_frame</code></td>
      </tr>
      <tr>
          <td>ÈáäÊîæ packet Êï∞ÊçÆ</td>
          <td><code>av_packet_unref</code></td>
      </tr>
      <tr>
          <td>ÂÖ≥Èó≠Â™í‰ΩìÊñá‰ª∂</td>
          <td><code>avformat_close_input</code></td>
      </tr>
  </tbody>
</table></div>
<h3 id="‰ª£Á†Å-2">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/avutil.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavformat/avformat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_DEBUG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage: %s &lt;input&gt; &lt;output&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inFilename</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outFilename</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">inFilename</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Open input format failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_find_stream_info</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Find stream info failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_find_best_stream</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Find best stream failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">videoIndex</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">outFilename</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Open output file failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">outFilename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nf">av_read_frame</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">videoIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">writeSize</span> <span class="o">=</span> <span class="nf">fwrite</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">writeSize</span> <span class="o">!=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// ËøôÈáå‰∏çËÉΩÈáäÊîæÊï¥‰∏™packetÔºåÂè™ËÉΩÈáäÊîæpacket‰∏≠ÁöÑdataÔºåÂõ†‰∏∫Âæ™ÁéØ‰πãÂêéËøò‰ºöÁî®Âà∞packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_packet_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">fail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">inFmtCtx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">dest_fp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÊàêÂäüËøêË°åÔºåË¶ÅÁî®aviÊ†ºÂºèÁöÑËßÜÈ¢ëÊñá‰ª∂</p>
<p>Â¶ÇÊûúÊÉ≥ÊèêÂèñmp4Ê†ºÂºèÁöÑÊñá‰ª∂ÔºåÈúÄË¶ÅËøõË°å‰ª•‰∏ãÊ≠•È™§</p>
<h2 id="mp4h264">mp4‚Üíh264
</h2><h3 id="ÊµÅÁ®ã-2">ÊµÅÁ®ã
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>ÂáΩÊï∞Âêç</th>
          <th>ÊèèËø∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>av_bsf_get_by_name</code></td>
          <td>Ê†πÊçÆÂêçÁß∞Ëé∑ÂèñÊØîÁâπÊµÅËøáÊª§Âô®</td>
      </tr>
      <tr>
          <td><code>av_bsf_alloc</code></td>
          <td>ÂàÜÈÖçÊØîÁâπÊµÅËøáÊª§Âô®‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>avcodec_parameters_copy</code></td>
          <td>Â§çÂà∂ÁºñËß£Á†ÅÂô®ÂèÇÊï∞</td>
      </tr>
      <tr>
          <td><code>av_bsf_init</code></td>
          <td>ÂàùÂßãÂåñÊØîÁâπÊµÅËøáÊª§Âô®</td>
      </tr>
      <tr>
          <td><code>av_bsf_send_packet</code></td>
          <td>ÂèëÈÄÅÊï∞ÊçÆÂåÖÂà∞ÊØîÁâπÊµÅËøáÊª§Âô®</td>
      </tr>
      <tr>
          <td><code>av_bsf_receive_packet</code></td>
          <td>‰ªéÊØîÁâπÊµÅËøáÊª§Âô®Êé•Êî∂Â§ÑÁêÜÂêéÁöÑÊï∞ÊçÆÂåÖ</td>
      </tr>
      <tr>
          <td><code>av_bsf_free</code></td>
          <td>ÈáäÊîæÊØîÁâπÊµÅËøáÊª§Âô®‰∏ä‰∏ãÊñáÂèäÁõ∏ÂÖ≥ËµÑÊ∫ê</td>
      </tr>
  </tbody>
</table></div>
<h3 id="‰ª£Á†Å-3">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/avutil.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavformat/avformat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavcodec/bsf.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_DEBUG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage: %s &lt;input&gt; &lt;output&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inFilename</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outFilename</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">inFilename</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Open input format failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_find_stream_info</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Find stream info failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_find_best_stream</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Find best stream failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">videoIndex</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">outFilename</span><span class="p">,</span> <span class="s">&#34;wb+&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Open output file failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">outFilename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">AVBitStreamFilter</span> <span class="o">*</span><span class="n">bsf</span> <span class="o">=</span> <span class="nf">av_bsf_get_by_name</span><span class="p">(</span><span class="s">&#34;h264_mp4toannexb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">bsf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;get h264_mp4toannexb bsf failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">AVBSFContext</span> <span class="o">*</span><span class="n">bsfCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_bsf_alloc</span><span class="p">(</span><span class="n">bsf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bsfCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">avcodec_parameters_copy</span><span class="p">(</span><span class="n">bsfCtx</span><span class="o">-&gt;</span><span class="n">par_in</span><span class="p">,</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">videoIndex</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_bsf_init</span><span class="p">(</span><span class="n">bsfCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nf">av_read_frame</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">videoIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nf">av_bsf_send_packet</span><span class="p">(</span><span class="n">bsfCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">while</span><span class="p">(</span><span class="nf">av_bsf_receive_packet</span><span class="p">(</span><span class="n">bsfCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="kt">int</span> <span class="n">writeSize</span> <span class="o">=</span> <span class="nf">fwrite</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">writeSize</span> <span class="o">!=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">// ËøôÈáå‰∏çËÉΩÈáäÊîæÊï¥‰∏™packetÔºåÂè™ËÉΩÈáäÊîæpacket‰∏≠ÁöÑdataÔºåÂõ†‰∏∫Âæ™ÁéØ‰πãÂêéËøò‰ºöÁî®Âà∞packet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                        <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_packet_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">fail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">inFmtCtx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">bsfCtx</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_bsf_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bsfCtx</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">dest_fp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ËΩ¨Â∞ÅË£Ö-mp4ËΩ¨flv">ËΩ¨Â∞ÅË£Ö-mp4ËΩ¨flv
</h2><h3 id="iÂ∏ßpÂ∏ßbÂ∏ß">IÂ∏ßÔºåPÂ∏ßÔºåBÂ∏ß
</h3><p>IÂ∏ßÔºöÂ∏ßÂÜÖÁºñÁ†ÅÂ∏ßÔºàIntra pictureÔºâÔºåIÂ∏ßÈÄöÂ∏∏ÊòØ‰∏Ä‰∏™GOPÁöÑÁ¨¨‰∏ÄÂ∏ßÔºåÁªèËøáËΩªÂ∫¶Âú∞ÂéãÁº©Ôºå‰Ωú‰∏∫ÈöèÊú∫ËÆøÈóÆÁöÑÂèÇËÄÉÁÇπÔºåÂèØ‰ª•ÂΩìÊàêÈùôÊÄÅÂõæÂÉèÔºåIÂ∏ßÂéãÁº©ÂèØÂéªÊéâËßÜÈ¢ëÁöÑÁ©∫Èó¥ÂÜó‰Ωô‰ø°ÊÅØ„ÄÇ</p>
<p>PÂ∏ßÔºöÂâçÂêëÈ¢ÑÊµãÁºñÁ†ÅÂ∏ßÔºàpredictive frameÔºâÔºåÈÄöËøáÂ∞ÜÂõæÂÉèÂ∫èÂàó‰∏≠ÂâçÈù¢Â∑≤ÁºñÁ†ÅÂ∏ßÁöÑÊó∂Èó¥ÂÜó‰Ωô‰ø°ÊÅØÂÖÖÂàÜÂéªÈô§Êù•ÂéãÁº©‰º†ËæìÊï∞ÊçÆÈáèÁöÑÁºñÁ†ÅÂõæÂÉèÔºå‰πüÁß∞‰∏∫È¢ÑÊµãÂ∏ß„ÄÇ</p>
<p>BÂ∏ßÔºöÂèåÂêëÈ¢ÑÊµãÂÜÖÊèíÁºñÁ†ÅÂ∏ßÔºåÊó¢ËÄÉËôëÊ∫êÂõæÂÉèÂ∫èÂàóÂâçÈù¢ÁöÑÂ∑≤ÁºñÁ†ÅÂ∏ßÔºåÂèàÈ°æÂèäÊ∫êÂõæÂÉèÂ∫èÂàóÂêéÈù¢ÁöÑÂ∑≤ÁºñÁ†ÅÂ∏ß‰πãÈó¥ÁöÑÊó∂Èó¥ÂÜó‰Ωô‰ø°ÊÅØÔºåÊù•ÂéãÁº©‰º†ËæìÊï∞ÊçÆÈáèÁöÑÁºñÁ†ÅÂõæÂÉèÔºå‰πüÁß∞‰∏∫ÂèåÂêëÈ¢ÑÊµãÂ∏ß</p>
<p>PTS-ÊòæÁ§∫Êó∂Èó¥Êà≥</p>
<p>DTS-Ëß£Á†ÅÊó∂Èó¥Êà≥</p>
<h3 id="ÊµÅÁ®ã-3">ÊµÅÁ®ã
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Ê≠•È™§</th>
          <th>ÂØπÂ∫îÂáΩÊï∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ÊâìÂºÄËæìÂÖ•Â™í‰ΩìÊñá‰ª∂</td>
          <td><code>avformat_open_input</code></td>
      </tr>
      <tr>
          <td>Ëé∑ÂèñËæìÂÖ•ÊµÅ‰ø°ÊÅØ</td>
          <td><code>avformat_find_stream_info</code></td>
      </tr>
      <tr>
          <td>ÂàõÂª∫ËæìÂá∫ÊµÅ‰∏ä‰∏ãÊñá</td>
          <td><code>avformat_alloc_output_context2</code></td>
      </tr>
      <tr>
          <td>ÂàõÂª∫ËæìÂá∫Á†ÅÊµÅÁöÑAVStream</td>
          <td><code>avformat_new_stream</code></td>
      </tr>
      <tr>
          <td>Êã∑Ë¥ùÁºñÁ†ÅÂèÇÊï∞</td>
          <td><code>avcodec_parameters_copy</code></td>
      </tr>
      <tr>
          <td>ÂÜôÂÖ•ËßÜÈ¢ëÊñá‰ª∂Â§¥</td>
          <td><code>avformat_write_header</code></td>
      </tr>
      <tr>
          <td>ËØªÂèñËæìÂÖ•ËßÜÈ¢ëÊµÅ</td>
          <td><code>av_read_frame</code></td>
      </tr>
      <tr>
          <td>ËÆ°ÁÆópts/dts/duration</td>
          <td><code>av_rescale_q_rnd</code>/<code>av_rescale_q</code></td>
      </tr>
      <tr>
          <td>ÂÜôÂÖ•ËßÜÈ¢ëÊµÅÊï∞ÊçÆ</td>
          <td><code>av_interleaved_write_frame</code></td>
      </tr>
      <tr>
          <td>ÂÜôÂÖ•ËßÜÈ¢ëÊñá‰ª∂Êú´Â∞æ</td>
          <td><code>av_write_trailer</code></td>
      </tr>
  </tbody>
</table></div>
<h3 id="‰ª£Á†Å-4">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/avutil.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavformat/avformat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_DEBUG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage: %s &lt;infileName&gt; &lt;outfileName&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">inFileName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open input format failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_find_stream_info</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find input stream failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">outFmtCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖçËæìÂá∫Ê†ºÂºè‰∏ä‰∏ãÊñá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_alloc_output_context2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">outFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;alloc output format failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËæìÂÖ•Êñá‰ª∂ÁöÑÊµÅÊï∞Èáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">streamCount</span> <span class="o">=</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">nb_streams</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖç‰∏Ä‰∏™Êï¥Êï∞Êï∞ÁªÑÔºåÁî®‰∫éÂ≠òÂÇ®ËæìÂÖ•ÊµÅÁ¥¢ÂºïÂà∞ËæìÂá∫ÊµÅÁ¥¢ÂºïÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÔºåÂπ∂Â∞ÜÂÖ∂ÂàùÂßãÂåñ‰∏∫Èõ∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="o">*</span><span class="n">handleStreamIndexArray</span> <span class="o">=</span> <span class="nf">av_malloc_array</span><span class="p">(</span><span class="n">streamCount</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">handleStreamIndexArray</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;malloc handle stream index array failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">streamIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Áî®‰∫éÂ§öÂ™í‰ΩìÂ§ÑÁêÜÁöÑÂæ™ÁéØÔºå‰∏ªË¶ÅÂäüËÉΩÊòØÂ∞ÜËæìÂÖ•Êñá‰ª∂‰∏≠ÁöÑÈü≥ËßÜÈ¢ëÊµÅÂ§çÂà∂Âà∞ËæìÂá∫Êñá‰ª∂‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">streamCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Ëé∑ÂèñËæìÂÖ•Êñá‰ª∂ÁöÑÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AVStream</span> <span class="o">*</span><span class="n">inStream</span> <span class="o">=</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Âà§Êñ≠ÊµÅÁöÑÁ±ªÂûãÔºàËßÜÈ¢ëÔºåÈü≥È¢ëÊàñÂ≠óÂπïÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">inStream</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">!=</span> <span class="n">AVMEDIA_TYPE_VIDEO</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="n">inStream</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">!=</span> <span class="n">AVMEDIA_TYPE_AUDIO</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="n">inStream</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">!=</span> <span class="n">AVMEDIA_TYPE_SUBTITLE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ‰∏çÂ§ÑÁêÜËØ•ÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">handleStreamIndexArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">handleStreamIndexArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">streamIndex</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ÂàõÂª∫Êñ∞ÁöÑËæìÂá∫ÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AVStream</span> <span class="o">*</span><span class="n">outStream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Âú®ËæìÂá∫Êñá‰ª∂‰∏≠ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">outStream</span> <span class="o">=</span> <span class="nf">avformat_new_stream</span><span class="p">(</span><span class="n">outFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">outStream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;new output stream failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â§çÂà∂ÁºñËß£Á†ÅÂô®ÂèÇÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">avcodec_parameters_copy</span><span class="p">(</span><span class="n">outStream</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="p">,</span> <span class="n">inStream</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ËÆæÁΩÆËæìÂá∫ÊµÅÁöÑÁºñËß£Á†ÅÂô®Ê†áÁ≠æ‰∏∫0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">outStream</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="o">-&gt;</span><span class="n">codec_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Âà§Êñ≠outFmtCtx-&gt;oformat-&gt;flagsÊòØÂê¶ÂåÖÂê´AVFMT_NOFILEÊ†áÂøó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="p">[</span><span class="o">&amp;</span><span class="err">Ëß£ÈáäÔºàÁÇπÂáªË∑≥ËΩ¨Ôºâ</span><span class="p">](</span><span class="nl">https</span><span class="p">:</span><span class="c1">//www.notion.so/if-outFmtCtx-oformat-flags-AVFMT_NOFILE-1187c25c79d08036bde1c286d0b3c943?pvs=21)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">outFmtCtx</span><span class="o">-&gt;</span><span class="n">oformat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AVFMT_NOFILE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ‰ª•ÂÜôÂÖ•Ê®°ÂºèÊâìÂºÄ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ret</span> <span class="o">=</span> <span class="nf">avio_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">outFmtCtx</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">,</span> <span class="n">AVIO_FLAG_WRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open output file failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜËæìÂá∫Êñá‰ª∂ÁöÑÂ§¥ÈÉ®‰ø°ÊÅØÂÜôÂÖ•Âà∞ËæìÂá∫Êñá‰ª∂‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_write_header</span><span class="p">(</span><span class="n">outFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;write header failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ËØªÂèñËæìÂÖ•Êñá‰ª∂ÁöÑÊï∞ÊçÆÂåÖ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nf">av_read_frame</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">&gt;=</span> <span class="n">streamCount</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="n">handleStreamIndexArray</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Ëé∑ÂèñËæìÂÖ•ËæìÂá∫Êñá‰ª∂‰∏≠ÂØπÂ∫îÊµÅÁ¥¢ÂºïÁöÑÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">AVStream</span> <span class="o">*</span><span class="n">inStream</span> <span class="o">=</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">AVStream</span> <span class="o">*</span><span class="n">outStream</span> <span class="o">=</span> <span class="n">outFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">=</span> <span class="n">handleStreamIndexArray</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="n">packet</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">=</span> <span class="nf">av_rescale_q</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">,</span> <span class="n">inStream</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">,</span> <span class="n">outStream</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">packet</span><span class="o">-&gt;</span><span class="n">dts</span> <span class="o">=</span> <span class="nf">av_rescale_q</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">dts</span><span class="p">,</span> <span class="n">inStream</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">,</span> <span class="n">outStream</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">packet</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">=</span> <span class="nf">av_rescale_q</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">duration</span><span class="p">,</span> <span class="n">inStream</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">,</span> <span class="n">outStream</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â∞ÜÊï∞ÊçÆÂåÖÁöÑ‰ΩçÁΩÆËÆæÁΩÆ‰∏∫-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">packet</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_interleaved_write_frame</span><span class="p">(</span><span class="n">outFmtCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;write interleaved failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_write_trailer</span><span class="p">(</span><span class="n">outFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;write trailer failed :%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">fail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inFmtCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">outFmtCtx</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">outFmtCtx</span><span class="o">-&gt;</span><span class="n">oformat</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AVFMT_NOFILE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avio_closep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">outFmtCtx</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">outFmtCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_free_context</span><span class="p">(</span><span class="n">outFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">handleStreamIndexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_freep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handleStreamIndexArray</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="Êà™ÂèñÂ∞ÅË£ÖÊñá‰ª∂">Êà™ÂèñÂ∞ÅË£ÖÊñá‰ª∂
</h2><h3 id="Êó∂Èó¥Âü∫‰∏éÊó∂Èó¥Êà≥">Êó∂Èó¥Âü∫‰∏éÊó∂Èó¥Êà≥
</h3><p>Êó∂Èó¥Âü∫ÔºöÊó∂Èó¥ÂàªÂ∫¶ÔºåË°®Á§∫ÊØè‰∏™ÂàªÂ∫¶Â§öÂ∞ëÁßíÔºàÂ∞±ÂÉè‰∏ÄÊääÂ∞∫Â≠êÁöÑÂàªÂ∫¶Ôºâ</p>
<p>Êó∂Èó¥Êà≥ÔºöË°®Á§∫Âç†Â§öÂ∞ë‰∏™Êó∂Èó¥ÂàªÂ∫¶ÔºåÂçï‰Ωç‰∏çÊòØÁßíÔºåËÄåÊòØÊó∂Èó¥ÂàªÂ∫¶ÔºàÂ§öÂ∞ëÂ§öÂ∞ëcmÔºâ</p>
<p>Êó∂Èó¥Âü∫ÂíåÊó∂Èó¥Êà≥Áõ∏‰πòÂ∞±ÊòØÊó∂Èó¥</p>
<p>PTSÔºöÊòæÁ§∫Êó∂Èó¥Êà≥ÔºåÂú®‰ªÄ‰πàÊó∂ÂÄôÂºÄÂßãÊòæÁ§∫Ëøô‰∏ÄÂ∏ßÊï∞ÊçÆÔºåËΩ¨ÊàêÊó∂Èó¥ÔºöPTS * Êó∂Èó¥Âü∫</p>
<p>DTSÔºöËß£Á†ÅÊó∂Èó¥Êà≥ÔºåÂú®‰ªÄ‰πàÊó∂ÂÄôÂºÄÂßãËß£Á†ÅËøô‰∏ÄÂ∏ßÊï∞ÊçÆÔºåËΩ¨ÊàêÊó∂Èó¥ÔºöDTS * Êó∂Èó¥Âü∫</p>
<h3 id="ÊµÅÁ®ã-4">ÊµÅÁ®ã
</h3><p>Êà™ÂèñÂ∞ÅË£ÖÊñá‰ª∂Â§ÑÁêÜÊµÅÁ®ãÂíåËΩ¨Â∞ÅË£ÖÊµÅÁ®ãÂá†‰πé‰∏ÄÊ†∑ÔºåÂè™ÊòØÂ§ö‰∫Ü‰∏Ä‰∏™Ë∑≥ËΩ¨ÊåáÂÆöÊó∂Èó¥Êà≥ÁöÑÊ≠•È™§„ÄÇ‰ª•‰∏ãÊòØËØ¶ÁªÜÊµÅÁ®ãÔºö</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>Ê≠•È™§</th>
          <th>ÂØπÂ∫îÂáΩÊï∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>1. ÊâìÂºÄËæìÂÖ•Â™í‰ΩìÊñá‰ª∂</td>
          <td><code>avformat_open_input</code></td>
      </tr>
      <tr>
          <td>2. Ëé∑ÂèñËæìÂÖ•ÊµÅ‰ø°ÊÅØ</td>
          <td><code>avformat_find_stream_info</code></td>
      </tr>
      <tr>
          <td>3. ÂàõÂª∫ËæìÂá∫ÊµÅ‰∏ä‰∏ãÊñá</td>
          <td><code>avformat_alloc_output_context2</code></td>
      </tr>
      <tr>
          <td>4. ÂàõÂª∫ËæìÂá∫Á†ÅÊµÅÁöÑAVStream</td>
          <td><code>avformat_new_stream</code></td>
      </tr>
      <tr>
          <td>5. Êã∑Ë¥ùÁºñÁ†ÅÂèÇÊï∞</td>
          <td><code>avcodec_parameters_copy</code></td>
      </tr>
      <tr>
          <td>6. ÂÜôÂÖ•ËßÜÈ¢ëÊñá‰ª∂Â§¥</td>
          <td><code>avformat_write_header</code></td>
      </tr>
      <tr>
          <td>7. ËØªÂèñËæìÂÖ•ËßÜÈ¢ëÊµÅ</td>
          <td><code>av_read_frame</code></td>
      </tr>
      <tr>
          <td>8. Ë∑≥ËΩ¨ÊåáÂÆöÊó∂Èó¥Êà≥</td>
          <td><code>av_seek_frame</code></td>
      </tr>
      <tr>
          <td>9. ËÆ°ÁÆópts/dts/duration</td>
          <td><code>av_rescale_q_rnd</code>/<code>av_rescale_q</code></td>
      </tr>
      <tr>
          <td>10. ÂÜôÂÖ•ËßÜÈ¢ëÊµÅÊï∞ÊçÆ</td>
          <td><code>av_interleaved_write_frame</code></td>
      </tr>
      <tr>
          <td>11. ÂÜôÂÖ•ËßÜÈ¢ëÊñá‰ª∂Êú´Â∞æ</td>
          <td><code>av_write_trailer</code></td>
      </tr>
  </tbody>
</table></div>
<h3 id="‰ª£Á†Å-5">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/avutil.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavformat/avformat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavcodec/avcodec.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆÊó•ÂøóÁ∫ßÂà´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_INFO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage:%s &lt;infileName&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊâìÂºÄËæìÂÖ•Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>                       <span class="c1">// Áî®‰∫éÂ≠òÂÇ®ËæìÂÖ•Êñá‰ª∂ÁöÑÊ†ºÂºè‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">inFileName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">// ÊâìÂºÄËæìÂÖ•Êñá‰ª∂inFileNameÔºåÂπ∂Â∞ÜÊ†ºÂºè‰ø°ÊÅØÂ≠òÂÇ®Âú®inFmtCtx‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">avformat_find_stream_info</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="c1">// Êü•ÊâæËæìÂÖ•Êñá‰ª∂ÁöÑÊµÅ‰ø°ÊÅØÔºåÂπ∂Â∞ÜÊµÅ‰ø°ÊÅØÂ≠òÂÇ®Âú®inFmtCtx‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_dump_format</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inFileName</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// ÊâìÂç∞ËæìÂÖ•Êñá‰ª∂inFileNameÁöÑÊ†ºÂºè‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_INFO</span><span class="p">,</span> <span class="s">&#34;input file duration:%ld us, %lf s </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">duration</span><span class="p">,</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">duration</span> <span class="o">*</span> <span class="nf">av_q2d</span><span class="p">(</span><span class="n">AV_TIME_BASE_Q</span><span class="p">));</span> <span class="c1">// ÊâìÂç∞ËæìÂÖ•Êñá‰ª∂ÁöÑÊÄªÊó∂ÈïøÔºåÂçï‰Ωç‰∏∫ÂæÆÁßíÂíåÁßí AV_TIME_BASE_QÊòØffmpegÂÜÖÈÉ®ÁöÑÊó∂Èó¥Âü∫ÔºåÂÄº‰∏∫{1, AV_TIME_BASE}ÔºåAV_TIME_BASEÁöÑÂÄº‰∏∫1000000ÔºåÂç≥1Áßí
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// AVRationalÊòØffmpegÂÜÖÈÉ®ÁöÑÊó∂Èó¥Âü∫ÔºåÂÄº‰∏∫{num, den}Ôºånum‰∏∫ÂàÜÂ≠êÔºåden‰∏∫ÂàÜÊØç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVRational</span> <span class="n">videoTimeBase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVRational</span> <span class="n">audioTimeBase</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">nb_streams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="c1">// ÈÅçÂéÜËæìÂÖ•Êñá‰ª∂‰∏≠ÁöÑÊâÄÊúâÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AVStream</span> <span class="o">*</span><span class="n">inStream</span> <span class="o">=</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="c1">// Ëé∑ÂèñËæìÂÖ•Êñá‰ª∂‰∏≠ÁöÑÁ¨¨i‰∏™ÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ÂàÜÂà´Âà§Êñ≠ÊòØÂê¶‰∏∫Èü≥È¢ëÊàñËßÜÈ¢ëÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">inStream</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">==</span> <span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">videoTimeBase</span> <span class="o">=</span> <span class="n">inStream</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_INFO</span><span class="p">,</span> <span class="s">&#34;video timebase:num = %d,den = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">videoTimeBase</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">videoTimeBase</span><span class="p">.</span><span class="n">den</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inStream</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">==</span> <span class="n">AVMEDIA_TYPE_AUDIO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">audioTimeBase</span> <span class="o">=</span> <span class="n">inStream</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_INFO</span><span class="p">,</span> <span class="s">&#34;audio timebase:num = %d,den = %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">audioTimeBase</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">audioTimeBase</span><span class="p">.</span><span class="n">den</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>        <span class="c1">// ÂàÜÈÖç‰∏Ä‰∏™AVPacketÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®Ëß£Á†ÅÂêéÁöÑÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nf">av_read_frame</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">// Âæ™ÁéØËØªÂèñËæìÂÖ•Êñá‰ª∂‰∏≠ÁöÑÊØè‰∏™Êï∞ÊçÆÂåÖÔºåÂπ∂Â∞ÜÊï∞ÊçÆÂåÖÂ≠òÂÇ®Âú®packet‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AVStream</span> <span class="o">*</span><span class="n">inStream</span> <span class="o">=</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span><span class="p">];</span> <span class="c1">// Ëé∑ÂèñÂΩìÂâçÊï∞ÊçÆÂåÖÊâÄÂ±ûÁöÑÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_INFO</span><span class="p">,</span> <span class="s">&#34;streamIndex = %d,pts = %ld,ptsTime = %lf,dts = %ld,dtsTime = %lf</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">pts</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">pts</span> <span class="o">*</span> <span class="nf">av_q2d</span><span class="p">(</span><span class="n">inStream</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">),</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">dts</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">dts</span> <span class="o">*</span> <span class="nf">av_q2d</span><span class="p">(</span><span class="n">inStream</span><span class="o">-&gt;</span><span class="n">time_base</span><span class="p">));</span> <span class="c1">// ÊâìÂç∞ÂΩìÂâçÊï∞ÊçÆÂåÖÁöÑÊµÅÁ¥¢Âºï„ÄÅpts„ÄÅptsÊó∂Èó¥„ÄÅdts„ÄÅdtsÊó∂Èó¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ËßÜÈ¢ëËß£Á†Å">ËßÜÈ¢ëËß£Á†Å
</h2><p>Â¶Ç‰Ωï‰ΩøÁî®ffmpegÊé•Âè£ÂØπËßÜÈ¢ëËß£Á†Å</p>
<h3 id="rgb‰ªãÁªç">RGB‰ªãÁªç
</h3><p><strong>‰∏âÂéüËâ≤</strong>ÔºöRGBËâ≤ÂΩ©Ê®°ÂºèÊòØÂ∑•‰∏öÁïåÁöÑ‰∏ÄÁßçÈ¢úËâ≤Ê†áÂáÜÔºåÊòØÈÄöËøáÂØπÁ∫¢(R)„ÄÅÁªø(G)„ÄÅËìù(B)‰∏â‰∏™È¢úËâ≤ÈÄöÈÅìÁöÑÂèòÂåñ‰ª•ÂèäÂÆÉ‰ª¨Áõ∏‰∫í‰πãÈó¥ÁöÑÂè†Âä†Êù•ÂæóÂà∞ÂêÑÂºèÂêÑÊ†∑ÁöÑÈ¢úËâ≤ÁöÑÔºåRGBÂç≥ÊòØ‰ª£Ë°®Á∫¢„ÄÅÁªø„ÄÅËìù‰∏â‰∏™ÈÄöÈÅìÁöÑÈ¢úËâ≤ÔºåËøô‰∏™Ê†áÂáÜÂá†‰πéÂåÖÊã¨‰∫Ü‰∫∫Á±ªËßÜÂäõÊâÄËÉΩÊÑüÁü•ÁöÑÊâÄÊúâÈ¢úËâ≤ÔºåÊòØÁõÆÂâçËøêÁî®ÊúÄÂπøÁöÑÈ¢úËâ≤Á≥ªÁªü‰πã‰∏Ä„ÄÇ</p>
<p><strong>ÊòæÁ§∫Âô®</strong>Ôºö‰ΩøÁî®RGB‰∏âÁßçÈ¢úËâ≤ÁöÑÂèëÂÖâ‰Ωì‰Ωú‰∏∫Âü∫Êú¨ÂèëÂÖâÂçïÂÖÉ</p>
<p><strong>ÂàÜËæ®Áéá</strong>ÔºöÊâãÊú∫Â±èÂπïÂàÜËæ®ÁéáÊòØ1280<code>*</code>720ÔºåË°®Á§∫Â±èÂπï‰∏äÊúâ1280<code>*</code>720‰∏™ÂÉèÁ¥†ÁÇπÔºåÊØè‰∏™ÂÉèÁ¥†ÁÇπÁî±RGB‰∏âÁßçÈ¢úËâ≤ÁªÑÊàê</p>
<h4 id="rgbÊ†ºÂºè">RGBÊ†ºÂºè
</h4><p><strong>Ë∞ÉËâ≤Áâà</strong>ÔºöÈÄöËøáÁºñÂè∑Êò†Â∞ÑÂà∞È¢úËâ≤ÁöÑ‰∏ÄÂº†‰∫åÁª¥Ë°®ÔºåÂ¶Ç01Á¥¢ÂºïÔºåË°®Á§∫Á∫¢Ëâ≤
<strong>Á¥¢ÂºïÊ†ºÂºè</strong>Ôºö
RGB1„ÄÅRGB4„ÄÅRGB8 ÊòØËÆ°ÁÆóÊú∫ÂõæÂΩ¢Â≠¶‰∏≠Â∏∏ËßÅÁöÑÈ¢úËâ≤ÁºñÁ†ÅÊ†ºÂºèÔºåÂÆÉ‰ª¨‰ª£Ë°®‰∫Ü‰∏çÂêåÁöÑÈ¢úËâ≤Ê∑±Â∫¶ÂíåÂ≠òÂÇ®ÊñπÂºè„ÄÇ‰ª•‰∏ãÊòØÂØπËøô‰∫õÊ†ºÂºèÁöÑËß£ÈáäÔºö</p>
<ol>
<li>
<p><strong>RGB1</strong>Ôºö</p>
<ul>
<li><strong>È¢úËâ≤Ê∑±Â∫¶</strong>Ôºö1‰ΩçÔºàbitÔºâ„ÄÇ</li>
<li><strong>È¢úËâ≤Êï∞Èáè</strong>Ôºö2ÁßçÈ¢úËâ≤ÔºàÈÄöÂ∏∏ÊòØÈªëËâ≤ÂíåÁôΩËâ≤Ôºâ„ÄÇ</li>
<li><strong>Â∫îÁî®Âú∫ÊôØ</strong>ÔºöÂ∏∏Áî®‰∫éÊó©ÊúüÁöÑÂçïËâ≤ÊòæÁ§∫Âô®ÊàñÁÆÄÂçïÁöÑÂõæÂΩ¢ÁïåÈù¢ÔºåÂ¶ÇÊñáÊú¨Ê®°Âºè‰∏ãÁöÑÊòæÁ§∫„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>RGB4</strong>Ôºö</p>
<ul>
<li><strong>È¢úËâ≤Ê∑±Â∫¶</strong>Ôºö4‰ΩçÔºàbitÔºâ„ÄÇ</li>
<li><strong>È¢úËâ≤Êï∞Èáè</strong>Ôºö16ÁßçÈ¢úËâ≤„ÄÇ</li>
<li><strong>Â∫îÁî®Âú∫ÊôØ</strong>ÔºöÂ∏∏Áî®‰∫éÊó©ÊúüÁöÑÂΩ©Ëâ≤ÊòæÁ§∫Âô®Êàñ‰ΩéÂàÜËæ®ÁéáÂõæÂΩ¢ÁïåÈù¢ÔºåÂ¶ÇÊó©ÊúüÁöÑËÆ°ÁÆóÊú∫Ê∏∏ÊàèÊàñÁÆÄÂçïÁöÑÂõæÂΩ¢Â∫îÁî®Á®ãÂ∫è„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>RGB8</strong>Ôºö</p>
<ul>
<li><strong>È¢úËâ≤Ê∑±Â∫¶</strong>Ôºö8‰ΩçÔºàbitÔºâ„ÄÇ</li>
<li><strong>È¢úËâ≤Êï∞Èáè</strong>Ôºö256ÁßçÈ¢úËâ≤„ÄÇ</li>
<li><strong>Â∫îÁî®Âú∫ÊôØ</strong>ÔºöÂ∏∏Áî®‰∫éÊó©ÊúüÁöÑÂΩ©Ëâ≤ÊòæÁ§∫Âô®Êàñ‰ΩéÂàÜËæ®ÁéáÂõæÂΩ¢ÁïåÈù¢ÔºåÂ¶ÇÊó©ÊúüÁöÑËÆ°ÁÆóÊú∫Ê∏∏Êàè„ÄÅÁΩëÈ°µËÆæËÆ°‰∏≠ÁöÑË∞ÉËâ≤ÊùøÊ®°ÂºèÁ≠â„ÄÇ</li>
</ul>
</li>
</ol>
<p>Ëøô‰∫õÊ†ºÂºèÂú®Áé∞‰ª£ËÆ°ÁÆóÊú∫ÂõæÂΩ¢Â§ÑÁêÜ‰∏≠Â∑≤ÁªèËæÉÂ∞ë‰ΩøÁî®Ôºå‰ΩÜÂú®Êüê‰∫õÁâπÂÆöÁöÑÂ∫îÁî®Âú∫ÊôØÊàñÂéÜÂè≤Á†îÁ©∂‰∏≠‰ªçÁÑ∂ÂÖ∑ÊúâÂèÇËÄÉ‰ª∑ÂÄº„ÄÇ
<strong>ÂÉèÁ¥†Ê†ºÂºè</strong>Ôºö„ÄÇ„ÄÇ„ÄÇÔºàÂêéÁª≠ËßâÂæóÊúâÂøÖË¶ÅÂÜçË°•‰∏äÔºâ</p>
<p><strong>ÂëΩ‰ª§</strong></p>
<p>ffmpegÂëΩ‰ª§Â∞ÜÂõæÁâáËΩ¨RGBÊï∞ÊçÆ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffmpeg -i input.png -pix_fmt rgb24 output.rgb
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ê≥®ÊÑèËæìÂá∫‰ø°ÊÅØ‰∏≠‰ºöËæìÂá∫ÂõæÁâáÂ§ßÂ∞èÔºå‰∏ãÈù¢ÁöÑ<code>ffplay</code>ÈúÄË¶ÅÁî®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Stream #0:0: Video: png, rgba(pc, gbr/bt709/iec61966-2-1), 1920x1200 [SAR 5669:5669 DAR 8:5], 25 fps, 25 tbr, 25 tbn
</span></span></code></pre></td></tr></table>
</div>
</div><p>ffplayÂëΩ‰ª§Êí≠ÊîæRGBÊï∞ÊçÆ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffplay -f output.rgb -pix_fmt rgb24 -s widthxheight output.rgb
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÖ∂‰∏≠Ôºå<code>width</code> Âíå <code>height</code> ÊòØÂõæÁâáÁöÑÂÆΩÂ∫¶ÂíåÈ´òÂ∫¶ÔºåÊòØÂøÖË¶ÅÁöÑ‰ø°ÊÅØ„ÄÇ</p>
<p>ÈÄöËøáËß£Á†ÅÔºå‰ºöÂèëÁé∞ÁÖßÁâáÂÜÖÂ≠òÊòéÊòæÂèòÂ§ßÔºåÂõ†‰∏∫RGBÊ†ºÂºèÂ≠òÂÇ®‰∫ÜÊõ¥Â§öÁöÑÈ¢úËâ≤‰ø°ÊÅØÔºåÊâÄ‰ª•Êàë‰ª¨ÈúÄË¶ÅÂØπÁÖßÁâáËøõË°åÁºñÁ†Å</p>
<p>TODOÂÆåÂñÑ</p>
<h3 id="yuv‰ªãÁªç">YUV‰ªãÁªç
</h3><p>YUV ÊòØ‰∏ÄÁßçÈ¢úËâ≤ÁºñÁ†ÅÁ≥ªÁªüÔºåÂ∏∏Áî®‰∫éËßÜÈ¢ëÂíåÂõæÂÉèÂ§ÑÁêÜ‰∏≠„ÄÇ<code>Y</code> ‰ª£Ë°®‰∫ÆÂ∫¶ÔºàLuminanceÔºâÔºå<code>U</code> Âíå <code>V</code> ‰ª£Ë°®Ëâ≤Â∫¶ÔºàChrominanceÔºâ„ÄÇYUV Ê†ºÂºèÊúâÂ§öÁßçÂèò‰ΩìÔºåÂ¶Ç YUV420„ÄÅYUV422„ÄÅYUV444 Á≠â„ÄÇ</p>
<h3 id="ÊµÅÁ®ã-5">ÊµÅÁ®ã
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>ÂáΩÊï∞Âêç</th>
          <th>ÊèèËø∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>av_find_best_stream</code></td>
          <td>Âú®Â™í‰ΩìÊñá‰ª∂‰∏≠Êü•ÊâæÊúÄ‰Ω≥ÊµÅ</td>
      </tr>
      <tr>
          <td><code>avcodec_alloc_context3</code></td>
          <td>ÂàÜÈÖç‰∏Ä‰∏™ÁºñËß£Á†ÅÂô®‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>avcodec_parameters_to_context</code></td>
          <td>Â§çÂà∂ÁºñËß£Á†ÅÂô®ÂèÇÊï∞</td>
      </tr>
      <tr>
          <td><code>avcodec_find_decoder</code></td>
          <td>Êü•ÊâæÂπ∂Ëé∑ÂèñËßÜÈ¢ëËß£Á†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>avcodec_open2</code></td>
          <td>ÊâìÂºÄËß£Á†ÅÂô®‰∏ä‰∏ãÊñáÔºåÂπ∂‰∏éÊåáÂÆöÁöÑËß£Á†ÅÂô®ÂÖ≥ËÅî</td>
      </tr>
      <tr>
          <td><code>av_read_frame</code></td>
          <td>ËØªÂèñÂ∏ß</td>
      </tr>
      <tr>
          <td><code>avcodec_send_packet</code></td>
          <td>ÂèëÈÄÅÊï∞ÊçÆÂåÖÂà∞Ëß£Á†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>avcodec_receive_frame</code></td>
          <td>‰ªéËß£Á†ÅÂô®Êé•Êî∂Â∏ß</td>
      </tr>
  </tbody>
</table></div>
<p>ËæìÂÖ•Êåá‰ª§</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./demoBin ../video/test.mp4 test.yuv
</span></span><span class="line"><span class="cl">ffplay test.yuv -video_size 720x1280 -pixel_format yuv420p 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Â¶ÇÊûúÊí≠ÊîæÁöÑËßÜÈ¢ë‰π±Á†ÅÔºå‰∏ªË¶ÅÊòØÁî±‰∫é<code>width</code>Âíå<code>linesize</code>Â§ßÂ∞è‰∏ç‰∏ÄÊ†∑
ÂêéÁª≠ÁöÑÊõ¥ÊîπËßÜÈ¢ëÊ†ºÂºèÁöÑÊó∂ÂÄô‰ºöËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢ò</p>
<h3 id="‰ª£Á†Å-6">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/avutil.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavformat/avformat.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavcodec/avcodec.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ÂÆö‰πâ‰∏Ä‰∏™ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éËÆ∞ÂΩïËß£Á†ÅÁöÑÂ∏ßÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">frameCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Ëß£Á†ÅËßÜÈ¢ëÂ∏ßÁöÑÂáΩÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">decodeVideo</span><span class="p">(</span><span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜÊï∞ÊçÆÂåÖÂèëÈÄÅÂà∞Ëß£Á†ÅÂô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_send_packet</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÂèëÈÄÅÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not send packet:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖç‰∏Ä‰∏™AVFrameÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®Ëß£Á†ÅÂêéÁöÑÂ∏ßÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Âæ™ÁéØÊé•Êî∂Ëß£Á†ÅÂêéÁöÑÂ∏ßÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nf">avcodec_receive_frame</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â∞ÜÂ∏ßÊï∞ÊçÆÂÜôÂÖ•ËæìÂá∫Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">fwrite</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fwrite</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fwrite</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¢ûÂä†Â∏ßËÆ°Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">frameCount</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ËÆ∞ÂΩïÂΩìÂâçÂ∏ßÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_INFO</span><span class="p">,</span> <span class="s">&#34;frameCount:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">frameCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÂ∏ßÊï∞ÊçÆ‰∏ç‰∏∫Á©∫ÔºåÈáäÊîæÂ∏ßÂÜÖÂ≠ò
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆÊó•ÂøóÁ∫ßÂà´‰∏∫Ë∞ÉËØïÊ®°Âºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_DEBUG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•ÂëΩ‰ª§Ë°åÂèÇÊï∞ÊòØÂê¶Ê≠£Á°Æ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage: %s &lt;input&gt; &lt;output&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñËæìÂÖ•ÂíåËæìÂá∫Êñá‰ª∂Âêç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂÆö‰πâ‰∏Ä‰∏™AVFormatContextÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®ËæìÂÖ•Êñá‰ª∂ÁöÑÊ†ºÂºè‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊâìÂºÄËæìÂÖ•Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">inFileName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊâìÂºÄÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not open input file %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">inFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñËæìÂÖ•Êñá‰ª∂ÁöÑÊµÅ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_find_stream_info</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúËé∑ÂèñÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not find stream information:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Êü•ÊâæÊúÄ‰Ω≥ÁöÑËßÜÈ¢ëÊµÅÁ¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_find_best_stream</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊü•ÊâæÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not find best stream index:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñËßÜÈ¢ëÊµÅÁöÑÁ¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">videoIndex</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖç‰∏Ä‰∏™AVCodecContextÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®Ëß£Á†ÅÂô®‰∏ä‰∏ãÊñá‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">codecCtx</span> <span class="o">=</span> <span class="nf">avcodec_alloc_context3</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">codecCtx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÂàÜÈÖçÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not allocate codec context</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜÊµÅÂèÇÊï∞Â§çÂà∂Âà∞Ëß£Á†ÅÂô®‰∏ä‰∏ãÊñá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">avcodec_parameters_to_context</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">videoIndex</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Êü•ÊâæËß£Á†ÅÂô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">AVCodec</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="nf">avcodec_find_decoder</span><span class="p">(</span><span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">codec_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">decoder</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊü•ÊâæÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not find codec</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊâìÂºÄËß£Á†ÅÂô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_open2</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊâìÂºÄÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not open codec:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊâìÂºÄËæìÂá∫Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="s">&#34;wb+&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊâìÂºÄÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not open output file %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖç‰∏Ä‰∏™AVPacketÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®Êï∞ÊçÆÂåÖ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖç‰∏Ä‰∏™AVFrameÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®Ëß£Á†ÅÂêéÁöÑÂ∏ßÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Âæ™ÁéØËØªÂèñËæìÂÖ•Êñá‰ª∂‰∏≠ÁöÑÊï∞ÊçÆÂåÖ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nf">av_read_frame</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊï∞ÊçÆÂåÖÂ±û‰∫éËßÜÈ¢ëÊµÅff
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">videoIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Ëß£Á†ÅËßÜÈ¢ëÂ∏ß
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nf">decodeVideo</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ÈáäÊîæÊï∞ÊçÆÂåÖÂºïÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Âà∑Êñ∞Ëß£Á†ÅÂô®ÔºåÁ°Æ‰øùÊâÄÊúâÂ∏ßÈÉΩË¢´Ëß£Á†Å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">decodeVideo</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">fail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúËæìÂÖ•Êñá‰ª∂Ê†ºÂºè‰∏ä‰∏ãÊñá‰∏ç‰∏∫Á©∫ÔºåÂÖ≥Èó≠ËæìÂÖ•Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">inFmtCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúËß£Á†ÅÂô®‰∏ä‰∏ãÊñá‰∏ç‰∏∫Á©∫ÔºåÈáäÊîæËß£Á†ÅÂô®‰∏ä‰∏ãÊñá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">codecCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avcodec_free_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codecCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúËæìÂá∫Êñá‰ª∂ÊåáÈíà‰∏ç‰∏∫Á©∫ÔºåÂÖ≥Èó≠ËæìÂá∫Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="Êõ¥ÊîπËßÜÈ¢ëÊ†ºÂºè">Êõ¥ÊîπËßÜÈ¢ëÊ†ºÂºè
</h2><h3 id="ÊµÅÁ®ã-6">ÊµÅÁ®ã
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>ÂáΩÊï∞Âêç</th>
          <th>ÊèèËø∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>av_parse_video_size</code></td>
          <td>Ëß£ÊûêËßÜÈ¢ëÂ∞∫ÂØ∏Â≠óÁ¨¶‰∏≤ÔºàÂ¶Ç &ldquo;1920x1080&rdquo;ÔºâÂπ∂ËøîÂõûÂÆΩÂ∫¶ÂíåÈ´òÂ∫¶„ÄÇ</td>
      </tr>
      <tr>
          <td><code>sws_getContext</code></td>
          <td>ÂàõÂª∫‰∏Ä‰∏™ <code>SwsContext</code>ÔºåÁî®‰∫éÂõæÂÉèÁº©ÊîæÂíåÊ†ºÂºèËΩ¨Êç¢„ÄÇ</td>
      </tr>
      <tr>
          <td><code>av_frame_alloc</code></td>
          <td>ÂàÜÈÖç‰∏Ä‰∏™ <code>AVFrame</code> ÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®Ëß£Á†ÅÂêéÁöÑËßÜÈ¢ëÂ∏ß„ÄÇ</td>
      </tr>
      <tr>
          <td><code>av_image_get_buffer_size</code></td>
          <td>ËÆ°ÁÆóÁªôÂÆöÂõæÂÉèÊ†ºÂºèÂíåÂ∞∫ÂØ∏ÊâÄÈúÄÁöÑÁºìÂÜ≤Âå∫Â§ßÂ∞è„ÄÇ</td>
      </tr>
      <tr>
          <td><code>av_malloc</code></td>
          <td>ÂàÜÈÖçÂÜÖÂ≠òÔºåÁî®‰∫éÂ≠òÂÇ®ÂõæÂÉèÊï∞ÊçÆ„ÄÇ</td>
      </tr>
      <tr>
          <td><code>av_image_fill_arrays</code></td>
          <td>Â∞ÜÂõæÂÉèÊï∞ÊçÆÂ°´ÂÖÖÂà∞ <code>AVFrame</code> ÁöÑÁºìÂÜ≤Âå∫‰∏≠ÔºåÂπ∂ËÆæÁΩÆÁõ∏ÂÖ≥ÁöÑË°åÂ§ßÂ∞èÂíåÊï∞ÊçÆÊåáÈíà„ÄÇ</td>
      </tr>
      <tr>
          <td><code>sws_scale</code></td>
          <td>‰ΩøÁî® <code>SwsContext</code> ÂØπÂõæÂÉèËøõË°åÁº©ÊîæÊàñÊ†ºÂºèËΩ¨Êç¢„ÄÇ</td>
      </tr>
  </tbody>
</table></div>
<h3 id="‰ª£Á†Å-7">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/avutil.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavformat/avformat.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavcodec/avcodec.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libswscale/swscale.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/parseutils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/imgutils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ÂÆö‰πâ‰∏Ä‰∏™ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éËÆ∞ÂΩïËß£Á†ÅÁöÑÂ∏ßÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">frameCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Ëß£Á†ÅËßÜÈ¢ëÂ∏ßÁöÑÂáΩÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="nf">decodeVideo</span><span class="p">(</span><span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="k">struct</span> <span class="n">SwsContext</span> <span class="o">*</span><span class="n">swsCtx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">destWidth</span><span class="p">,</span> <span class="kt">int</span> <span class="n">destHeight</span><span class="p">,</span> <span class="n">AVFrame</span> <span class="o">*</span><span class="n">destFrame</span><span class="p">,</span> <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜÊï∞ÊçÆÂåÖÂèëÈÄÅÂà∞Ëß£Á†ÅÂô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_send_packet</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÂèëÈÄÅÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not send packet:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖç‰∏Ä‰∏™AVFrameÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®Ëß£Á†ÅÂêéÁöÑÂ∏ßÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Âæ™ÁéØÊé•Êî∂Ëß£Á†ÅÂêéÁöÑÂ∏ßÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nf">avcodec_receive_frame</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sws_scale</span><span class="p">(</span><span class="n">swsCtx</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="k">const</span><span class="o">*</span><span class="p">)</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â∞ÜÂ∏ßÊï∞ÊçÆÂÜôÂÖ•ËæìÂá∫Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">fwrite</span><span class="p">(</span><span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">destWidth</span> <span class="o">*</span> <span class="n">destHeight</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fwrite</span><span class="p">(</span><span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">destWidth</span> <span class="o">*</span> <span class="n">destHeight</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fwrite</span><span class="p">(</span><span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">destWidth</span> <span class="o">*</span> <span class="n">destHeight</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¢ûÂä†Â∏ßËÆ°Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">frameCount</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ËÆ∞ÂΩïÂΩìÂâçÂ∏ßÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_INFO</span><span class="p">,</span> <span class="s">&#34;frameCount:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">frameCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ËæìÂá∫ÂÆΩÈ´ò‰ø°ÊÅØ,linesize0 1 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_INFO</span><span class="p">,</span> <span class="s">&#34;width:%d,height:%d,linesize0:%d,linesize1:%d,linesize2:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">destWidth</span><span class="p">,</span> <span class="n">destHeight</span><span class="p">,</span> <span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúÂ∏ßÊï∞ÊçÆ‰∏ç‰∏∫Á©∫ÔºåÈáäÊîæÂ∏ßÂÜÖÂ≠ò
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆÊó•ÂøóÁ∫ßÂà´‰∏∫Ë∞ÉËØïÊ®°Âºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_DEBUG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•ÂëΩ‰ª§Ë°åÂèÇÊï∞ÊòØÂê¶Ê≠£Á°Æ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage: %s &lt;input&gt; &lt;output&gt; &lt;width*height&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñËæìÂÖ•ÂíåËæìÂá∫Êñá‰ª∂Âêç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">destVideoSizeString</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">destWidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">destHeight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_parse_video_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">destWidth</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">destHeight</span><span class="p">,</span> <span class="n">destVideoSizeString</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;invalid video size:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">destVideoSizeString</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_INFO</span><span class="p">,</span> <span class="s">&#34;destWith:%d,destHeight:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">destWidth</span><span class="p">,</span> <span class="n">destHeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂÆö‰πâ‰∏Ä‰∏™AVFormatContextÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®ËæìÂÖ•Êñá‰ª∂ÁöÑÊ†ºÂºè‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊâìÂºÄËæìÂÖ•Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">inFileName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊâìÂºÄÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not open input file %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">inFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñËæìÂÖ•Êñá‰ª∂ÁöÑÊµÅ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_find_stream_info</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúËé∑ÂèñÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not find stream information:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Êü•ÊâæÊúÄ‰Ω≥ÁöÑËßÜÈ¢ëÊµÅÁ¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_find_best_stream</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊü•ÊâæÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not find best stream index:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñËßÜÈ¢ëÊµÅÁöÑÁ¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">videoIndex</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖç‰∏Ä‰∏™AVCodecContextÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®Ëß£Á†ÅÂô®‰∏ä‰∏ãÊñá‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">codecCtx</span> <span class="o">=</span> <span class="nf">avcodec_alloc_context3</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">codecCtx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÂàÜÈÖçÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not allocate codec context</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜÊµÅÂèÇÊï∞Â§çÂà∂Âà∞Ëß£Á†ÅÂô®‰∏ä‰∏ãÊñá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">avcodec_parameters_to_context</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">videoIndex</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Êü•ÊâæËß£Á†ÅÂô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">const</span> <span class="n">AVCodec</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="nf">avcodec_find_decoder</span><span class="p">(</span><span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">codec_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">decoder</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊü•ÊâæÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not find codec</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊâìÂºÄËß£Á†ÅÂô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_open2</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊâìÂºÄÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not open codec:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">enum</span> <span class="n">AVPixelFormat</span> <span class="n">destPixfmt</span> <span class="o">=</span> <span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">SwsContext</span> <span class="o">*</span><span class="n">swsCtx</span> <span class="o">=</span> <span class="nf">sws_getContext</span><span class="p">(</span><span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">codecCtx</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">,</span> <span class="n">destWidth</span><span class="p">,</span> <span class="n">destHeight</span><span class="p">,</span> <span class="n">destPixfmt</span><span class="p">,</span> <span class="n">SWS_BICUBIC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">swsCtx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not create SwsContext</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">destFrame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">outBuffer</span> <span class="o">=</span> <span class="nf">av_malloc</span><span class="p">(</span><span class="nf">av_image_get_buffer_size</span><span class="p">(</span><span class="n">destPixfmt</span><span class="p">,</span> <span class="n">destWidth</span><span class="p">,</span> <span class="n">destHeight</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_image_fill_arrays</span><span class="p">(</span><span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">,</span> <span class="n">outBuffer</span><span class="p">,</span> <span class="n">destPixfmt</span><span class="p">,</span> <span class="n">destWidth</span><span class="p">,</span> <span class="n">destHeight</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊâìÂºÄËæìÂá∫Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="s">&#34;wb+&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊâìÂºÄÂ§±Ë¥•ÔºåËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not open output file %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖç‰∏Ä‰∏™AVPacketÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®Êï∞ÊçÆÂåÖ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖç‰∏Ä‰∏™AVFrameÁªìÊûÑ‰ΩìÔºåÁî®‰∫éÂ≠òÂÇ®Ëß£Á†ÅÂêéÁöÑÂ∏ßÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Âæ™ÁéØËØªÂèñËæìÂÖ•Êñá‰ª∂‰∏≠ÁöÑÊï∞ÊçÆÂåÖ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nf">av_read_frame</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÊï∞ÊçÆÂåÖÂ±û‰∫éËßÜÈ¢ëÊµÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">videoIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Ëß£Á†ÅËßÜÈ¢ëÂ∏ß
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// if (decodeVideo(codecCtx, packet, dest_fp) == -1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="nf">decodeVideo</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">swsCtx</span><span class="p">,</span> <span class="n">destWidth</span><span class="p">,</span> <span class="n">destHeight</span><span class="p">,</span> <span class="n">destFrame</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// ÈáäÊîæÊï∞ÊçÆÂåÖÂºïÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Âà∑Êñ∞Ëß£Á†ÅÂô®ÔºåÁ°Æ‰øùÊâÄÊúâÂ∏ßÈÉΩË¢´Ëß£Á†Å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// decodeVideo(codecCtx, NULL, dest_fp);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">decodeVideo</span><span class="p">(</span><span class="n">codecCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">swsCtx</span><span class="p">,</span> <span class="n">destWidth</span><span class="p">,</span> <span class="n">destHeight</span><span class="p">,</span> <span class="n">destFrame</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nl">fail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúËæìÂÖ•Êñá‰ª∂Ê†ºÂºè‰∏ä‰∏ãÊñá‰∏ç‰∏∫Á©∫ÔºåÂÖ≥Èó≠ËæìÂÖ•Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">inFmtCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúËß£Á†ÅÂô®‰∏ä‰∏ãÊñá‰∏ç‰∏∫Á©∫ÔºåÈáäÊîæËß£Á†ÅÂô®‰∏ä‰∏ãÊñá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">codecCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avcodec_free_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">codecCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúËæìÂá∫Êñá‰ª∂ÊåáÈíà‰∏ç‰∏∫Á©∫ÔºåÂÖ≥Èó≠ËæìÂá∫Êñá‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">destFrame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">destFrame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">outBuffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_free</span><span class="p">(</span><span class="n">outBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="Ëß£Á†ÅÂêéÁöÑÊï∞ÊçÆÂ≠òÂÇ®">Ëß£Á†ÅÂêéÁöÑÊï∞ÊçÆÂ≠òÂÇ®
</h3><p>Ëß£Á†ÅÂêéÁöÑËßÜÈ¢ëÊï∞ÊçÆÈÄöÂ∏∏Â≠òÂÇ®Âú® <code>data[0]</code>„ÄÅ<code>data[1]</code>„ÄÅ<code>data[2]</code> Á≠âÊï∞ÁªÑ‰∏≠„ÄÇÂÖ∑‰ΩìÊù•ËØ¥Ôºö</p>
<ul>
<li><strong><code>data[0]</code></strong>: Â≠òÂÇ®‰∫Ü <code>linesize[0] * height</code> ‰∏™Êï∞ÊçÆ„ÄÇ</li>
<li><strong><code>data[1]</code></strong> Âíå <strong><code>data[2]</code></strong>: Â≠òÂÇ®‰∫ÜÂÖ∂‰ªñÂπ≥Èù¢ÁöÑÊï∞ÊçÆÔºàÂ¶ÇYUVÊ†ºÂºè‰∏≠ÁöÑUÂíåVÂπ≥Èù¢Ôºâ„ÄÇ</li>
</ul>
<h3 id="ÂÜÖÂ≠òÂØπÈΩêÂíå-linesize">ÂÜÖÂ≠òÂØπÈΩêÂíå <code>linesize</code>
</h3><ul>
<li><strong><code>linesize[0]</code></strong>: ÂÆûÈôÖ‰∏äÂπ∂‰∏çÁ≠â‰∫éÂõæÂÉèÁöÑÂÆΩÂ∫¶ <code>width</code>ÔºåËÄåÊòØÊØîÂÆΩÂ∫¶Â§ß„ÄÇ</li>
<li>ËøôÁßçÂ∑ÆÂºÇÊòØÁî±‰∫éÂÜÖÂ≠òÂØπÈΩêÁöÑÈúÄÊ±ÇÔºå‰ª•ÂèäËß£Á†ÅÂô®ÁöÑCPUÂíåÂÖ∂‰ªñ‰ºòÂåñÂéüÂõ†ÂØºËá¥ÁöÑ„ÄÇ</li>
</ul>
<h3 id="sws_scale-ÂáΩÊï∞ÂäüËÉΩ"><code>sws_scale</code> ÂáΩÊï∞ÂäüËÉΩ
</h3><p><code>sws_scale</code> ÂáΩÊï∞ÊòØ FFmpeg ‰∏≠Áî®‰∫éÂõæÂÉèÁº©ÊîæÂíåÊ†ºÂºèËΩ¨Êç¢ÁöÑÊ†∏ÂøÉÂáΩÊï∞„ÄÇÂÆÉ‰∏ªË¶ÅÂÆåÊàê‰ª•‰∏ãÂäüËÉΩÔºö</p>
<ol>
<li>
<p><strong>ÂõæÂÉèËâ≤ÂΩ©Á©∫Èó¥ËΩ¨Êç¢</strong>Ôºö</p>
<ul>
<li>Â∞ÜÂõæÂÉè‰ªé‰∏ÄÁßçËâ≤ÂΩ©Á©∫Èó¥ËΩ¨Êç¢‰∏∫Âè¶‰∏ÄÁßçËâ≤ÂΩ©Á©∫Èó¥Ôºå‰æãÂ¶Ç‰ªé RGB ËΩ¨Êç¢‰∏∫ YUVÔºåÊàñËÄÖ‰ªé YUV420P ËΩ¨Êç¢‰∏∫ YUV444P„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ÂàÜËæ®ÁéáÁº©Êîæ</strong>Ôºö</p>
<ul>
<li>Ë∞ÉÊï¥ÂõæÂÉèÁöÑÂàÜËæ®ÁéáÔºå‰æãÂ¶ÇÂ∞Ü 1920x1080 ÁöÑÂõæÂÉèÁº©ÊîæÂà∞ 1280x720„ÄÇ</li>
</ul>
</li>
<li>
<p><strong>ÂâçÂêéÂõæÂÉèÊª§Ê≥¢Â§ÑÁêÜ</strong>Ôºö</p>
<ul>
<li>Âú®ËøõË°åÁº©ÊîæÂíåËâ≤ÂΩ©Á©∫Èó¥ËΩ¨Êç¢Êó∂ÔºåÂ∫îÁî®Êª§Ê≥¢Âô®‰ª•Âπ≥ÊªëÂõæÂÉèÔºåÂáèÂ∞ëÈîØÈΩøÂíå‰º™ÂΩ±„ÄÇ</li>
</ul>
</li>
</ol>
<h3 id="bmpÊñá‰ª∂Ê†ºÂºè">BMPÊñá‰ª∂Ê†ºÂºè
</h3><p><strong>Ê¶ÇÂøµ</strong>ÔºöBMPÊñá‰ª∂Ê†ºÂºèÔºåÂèàÁß∞‰∏∫BitmapÔºà‰ΩçÂõæÔºâÊàñÊòØDIBÔºàDevice-Independent DeviceÔºåËÆæÂ§áÊó†ÂÖâ‰ΩçÂõæÔºâÔºåÊòØWindowsÊìç‰ΩúÁ≥ªÁªü‰∏≠ÁöÑÊ†áÂáÜÂõæÂÉèÊñá‰ª∂Ê†ºÂºè„ÄÇÁî±‰∫éÂÆÉÂèØ‰ª•‰∏ç‰Ωú‰ªª‰ΩïÂèòÊç¢Âú∞‰øùÂ≠òÂõæÂÉèÂÉèÁ¥†ÂüüÁöÑÊï∞ÊçÆÔºåÂõ†Ê≠§Êàê‰∏∫Êàë‰ª¨ÂèñÂæóRAWÊï∞ÊçÆÁöÑÂ•ΩÊù•Ê∫ê„ÄÇ</p>
<p><strong>Êâ´ÊèèÊñπÂºè</strong>Ôºö‰ªéÂ∑¶Âà∞Âè≥Ôºå‰ªé‰∏ãÂà∞‰∏ä</p>
<p><strong>Êñá‰ª∂ÁªÑÊàê</strong>Ôºö</p>
<ul>
<li>‰ΩçÂõæÊñá‰ª∂Â§¥ÔºàBitmap File HeaderÔºâÔºöÊèê‰æõÊñá‰ª∂ÁöÑÊ†ºÂºèÔºåÂ§ßÂ∞èÁ≠â‰ø°ÊÅØ</li>
<li>‰ΩçÂõæ‰ø°ÊÅØÂ§¥ÔºàBitmap InformationÔºâÔºöÊèê‰æõÂõæÂÉèÁöÑÂ∞∫ÂØ∏Ôºå‰ΩçÂπ≥Èù¢Êï∞ÔºåÂéãÁº©ÊñπÂºèÔºåÈ¢úËâ≤Á¥¢ÂºïÁ≠â‰ø°ÊÅØ„ÄÇ</li>
<li>Ë∞ÉËâ≤ÊùøÔºàColor PaletteÔºâÔºöÂèØÈÄâÔºåÊúâ‰∫õ‰ΩçÂõæÈúÄË¶ÅË∞ÉËâ≤ÊùøÔºåÊúâ‰∫õ‰ΩçÂõæÔºåÊØîÂ¶ÇÁúüÂΩ©Ëâ≤ÂõæÔºà24‰ΩçÁöÑBMPÔºâÂ∞±‰∏çÈúÄË¶ÅË∞ÉËâ≤Êùø„ÄÇ</li>
<li>‰ΩçÂõæÊï∞ÊçÆÔºàBitmap DataÔºâÔºöÂõæÂÉèÊï∞ÊçÆÂå∫</li>
</ul>
<p><strong>Êñá‰ª∂Â§¥ÁªìÊûÑ‰Ωì</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tagBITMAPFILEHEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">WORD</span> <span class="n">bfType</span><span class="p">;</span>                    <span class="c1">// Êñá‰ª∂Á±ªÂûãÔºåÂøÖÈ°ªÊòØ0x424DÔºåÂç≥Â≠óÁ¨¶‚ÄúBM‚Äù
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">bfSize</span><span class="p">;</span>                   <span class="c1">// bmpÊñá‰ª∂Â§ßÂ∞è
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">bfReserved1</span><span class="p">;</span>               <span class="c1">// ‰øùÁïôÂ≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">bfReserved2</span><span class="p">;</span>               <span class="c1">// ‰øùÁïôÂ≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">bfOffBits</span><span class="p">;</span>                <span class="c1">// ÂÆûÈôÖ‰ΩçÂõæÊï∞ÊçÆÁöÑÂÅèÁßªÂ≠óËäÇÊï∞ÔºåÂç≥Ââç‰∏â‰∏™ÈÉ®ÂàÜÈïøÂ∫¶‰πãÂíå
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="n">BITMAPFILEHEADER</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>‰ø°ÊÅØÂ§¥ÁªìÊûÑ‰Ωì</strong>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">tagBITMAPINFOHEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">DWORD</span> <span class="n">biSize</span><span class="p">;</span>                   <span class="c1">//Ë°®Á§∫struct tagBITMAPINFOHEADERÁöÑÈïøÂ∫¶ÔºåËÆæ‰∏∫40
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LONG</span> <span class="n">biWidth</span><span class="p">;</span>                   <span class="c1">//bmpÂõæÁâáÂÆΩÂ∫¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LONG</span> <span class="n">biHeight</span><span class="p">;</span>                  <span class="c1">//bmpÂõæÁâáÈ´òÂ∫¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">biPlanes</span><span class="p">;</span>                  <span class="c1">//bmpÂõæÁâáÂπ≥Èù¢Ê†ëÔºåËÆæ‰∏∫1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WORD</span> <span class="n">biBitCount</span><span class="p">;</span>                <span class="c1">//bmpÂõæÁâá‰ΩçÊï∞ÔºåÂç≥1‰ΩçÂõæÔºå4‰ΩçÂõæÔºå8‰ΩçÂõæÔºå24‰ΩçÂõæÁ≠â
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">biCompression</span><span class="p">;</span>            <span class="c1">//bmpÂõæÁâáÂéãÁº©Á±ªÂûãÔºå0Ë°®Á§∫‰∏çÂéãÁº©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">biSizeImage</span><span class="p">;</span>              <span class="c1">//bmpÂõæÁâáÊï∞ÊçÆÂ§ßÂ∞èÔºåÂøÖÈ°ªÊòØ4ÁöÑÊï¥Êï∞ÂÄç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LONG</span> <span class="n">biXPelsPerMeter</span><span class="p">;</span>           <span class="c1">//bmpÂõæÁâáÊ∞¥Âπ≥ÂàÜËæ®Áéá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">LONG</span> <span class="n">biYPelsPerMeter</span><span class="p">;</span>           <span class="c1">//bmpÂõæÁâáÂûÇÁõ¥ÂàÜËæ®Áéá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">biClrUsed</span><span class="p">;</span>                <span class="c1">//bmpÂõæÁâáÂÆûÈôÖ‰ΩøÁî®ÁöÑÈ¢úËâ≤Ë°®‰∏≠ÁöÑÈ¢úËâ≤Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">DWORD</span> <span class="n">biClrImportant</span><span class="p">;</span>           <span class="c1">//bmpÂõæÁâáÂØπÊòæÁ§∫ÊúâÈáçË¶ÅÂΩ±ÂìçÁöÑÈ¢úËâ≤Á¥¢ÂºïÁöÑÊï∞ÁõÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="n">BITMAPINFOHEADER</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ËßÜÈ¢ëÁºñÁ†ÅyuvÂà∞h264">ËßÜÈ¢ëÁºñÁ†ÅÔºàyuvÂà∞h264Ôºâ
</h2><h3 id="ÊµÅÁ®ã-7">ÊµÅÁ®ã
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>ÂáΩÊï∞Âêç</th>
          <th>ÊèèËø∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>avcodec_find_encoder</code></td>
          <td>Êü•ÊâæÁºñÁ†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>avcodec_alloc_context3</code></td>
          <td>ÂàõÂª∫ÁºñÁ†ÅÂô®‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>avcodec_open2</code></td>
          <td>ÊâìÂºÄÁºñÁ†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>av_frame_alloc</code></td>
          <td>ÂàÜÈÖçÂ∏ßÂÜÖÂ≠ò</td>
      </tr>
      <tr>
          <td><code>av_image_get_buffer_size</code></td>
          <td>Ëé∑ÂèñÂõæÂÉèÁºìÂÜ≤Âå∫Â§ßÂ∞è</td>
      </tr>
      <tr>
          <td><code>av_image_fill_arrays</code></td>
          <td>Â°´ÂÖÖÂõæÂÉèÊï∞ÊçÆÊï∞ÁªÑ</td>
      </tr>
      <tr>
          <td><code>avcodec_send_frame</code></td>
          <td>ÂèëÈÄÅÂ∏ßÂà∞ÁºñÁ†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>avcodec_receive_packet</code></td>
          <td>‰ªéÁºñÁ†ÅÂô®Êé•Êî∂Êï∞ÊçÆÂåÖ</td>
      </tr>
  </tbody>
</table></div>
<h3 id="‰ª£Á†Å-8">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavcodec/avcodec.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/avutil.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/parseutils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavcodec/codec.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavcodec/packet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/frame.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/imgutils.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/log.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/rational.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">writePacketCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">encodeVideo</span><span class="p">(</span><span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_send_frame</span><span class="p">(</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;send frame error:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avcodec_receive_packet</span><span class="p">(</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">AVERROR_EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">AV_LOG_ERROR</span><span class="p">,</span><span class="s">&#34;encoder frrame failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fwrite</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">writePacketCount</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">AV_LOG_INFO</span><span class="p">,</span><span class="s">&#34;writePacketCount : %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">writePacketCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_INFO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage: %s &lt;inFile&gt; &lt;outFile&gt; &lt;encodeName&gt; &lt;width x height&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">encoderName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_parse_video_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="s">&#34;Invalid size &#39;%s&#39;, must be in the form WxH or a valid size abbreviation</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">               <span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">enum</span> <span class="n">AVPixelFormat</span> <span class="n">pixFmt</span> <span class="o">=</span> <span class="n">AV_PIX_FMT_YUV420P</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fps</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">AVCodec</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="nf">avcodec_find_encoder_by_name</span><span class="p">(</span><span class="n">encoderName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">encoder</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find encoder %s failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">encoderName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">encoderCtx</span> <span class="o">=</span> <span class="nf">avcodec_alloc_context3</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">encoderCtx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;alloc encoder context failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">codec_type</span> <span class="o">=</span> <span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">pix_fmt</span> <span class="o">=</span> <span class="n">pixFmt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">time_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">AVRational</span><span class="p">){</span><span class="mi">1</span><span class="p">,</span> <span class="n">fps</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">bit_rate</span> <span class="o">=</span> <span class="mi">4096000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">max_b_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">gop_size</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_open2</span><span class="p">(</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open encoder failed! %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">src_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">inFileName</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">src_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open infilename error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open outfilename error&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">frameSize</span> <span class="o">=</span> <span class="nf">av_image_get_buffer_size</span><span class="p">(</span><span class="n">pixFmt</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">frameBuffer</span> <span class="o">=</span> <span class="nf">av_malloc</span><span class="p">(</span><span class="n">frameSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_image_fill_arrays</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">,</span> <span class="n">frameBuffer</span><span class="p">,</span> <span class="n">pixFmt</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pictureSize</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">readFrameCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nf">fread</span><span class="p">(</span><span class="n">frameBuffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pictureSize</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">src_fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">pictureSize</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Y 1 U 1/4 V 1/4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">frameBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">frameBuffer</span> <span class="o">+</span> <span class="n">pictureSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">frameBuffer</span> <span class="o">+</span> <span class="n">pictureSize</span> <span class="o">+</span> <span class="n">pictureSize</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">readFrameCount</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_INFO</span><span class="p">,</span> <span class="s">&#34;readFrameCount: %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">readFrameCount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">encodeVideo</span><span class="p">(</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nl">end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">encoderCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avcodec_free_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoderCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">src_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">src_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">frameBuffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_freep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frameBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="Èü≥È¢ëËß£Á†Å">Èü≥È¢ëËß£Á†Å
</h2><h3 id="pcm‰ªãÁªç">PCM‰ªãÁªç
</h3><p>PCMÔºàPulse Code ModulationÔºâÊòØ‰∏ÄÁßçÁî®‰∫éÊï∞Â≠óÈü≥È¢ëÁöÑÊ†áÂáÜÁºñÁ†ÅÊ†ºÂºè„ÄÇÂÆÉÈÄöËøáÂ∞ÜÊ®°ÊãüÈü≥È¢ë‰ø°Âè∑ËΩ¨Êç¢‰∏∫Êï∞Â≠ó‰ø°Âè∑Êù•Ë°®Á§∫Èü≥È¢ëÊï∞ÊçÆ„ÄÇPCM ÁºñÁ†ÅÁöÑÂü∫Êú¨ÂéüÁêÜÊòØÂ∞ÜÊ®°ÊãüÈü≥È¢ë‰ø°Âè∑Âú®Êó∂Èó¥‰∏äËøõË°åÈááÊ†∑ÔºåÂπ∂Â∞ÜÊØè‰∏™ÈááÊ†∑ÁÇπÁöÑÂπÖÂ∫¶ÂÄºÈáèÂåñ‰∏∫Á¶ªÊï£ÁöÑÊï∞Â≠óÂÄº„ÄÇ<br>
Ê†∏ÂøÉËøáÁ®ãÔºöÈááÊ†∑-&gt;ÈáèÂåñ-&gt;ÁºñÁ†Å</p>
<h4 id="pcmÂÖ≥ÈîÆË¶ÅÁ¥†">PCMÂÖ≥ÈîÆË¶ÅÁ¥†
</h4><ul>
<li>ÈááÊ†∑ÁéáÔºàSample RateÔºâÔºöÊØèÁßíÈááÊ†∑ÁöÑÊ¨°Êï∞ÔºåÂ∏∏ËßÅÁöÑÈááÊ†∑ÁéáÊúâ 44.1 kHz„ÄÅ48 kHz Á≠â„ÄÇ</li>
<li>ÈáèÂåñÊ†ºÂºèÔºàSample FormatÔºâÔºöÊØè‰∏™ÈááÊ†∑ÁÇπÁöÑ‰ΩçÊï∞ÔºåÂ∏∏ËßÅÁöÑÈáèÂåñÊ†ºÂºèÊúâ 16 ‰Ωç„ÄÅ24 ‰ΩçÁ≠â„ÄÇ</li>
<li>Â£∞ÈÅìÊï∞ÔºàChannelsÔºâÔºöÈü≥È¢ë‰ø°Âè∑ÁöÑÂ£∞ÈÅìÊï∞ÔºåÂ¶ÇÂçïÂ£∞ÈÅì„ÄÅÁ´ã‰ΩìÂ£∞Á≠â„ÄÇ</li>
</ul>
<h4 id="pcmÊï∞ÊçÆÊ†ºÂºè">PCMÊï∞ÊçÆÊ†ºÂºè
</h4><ul>
<li>
<p>Â≠òÂÇ®Ê†ºÂºè</p>
<ul>
<li>ÂèåÂ£∞ÈÅìÔºöÈááÊ†∑Êï∞ÊçÆÊåâLRLRÊñπÂºèÂ≠òÂÇ®ÔºåÂç≥Â∑¶Â£∞ÈÅìÂíåÂè≥Â£∞ÈÅì‰∫§ÊõøÂ≠òÂÇ®ÔºåÂ≠òÂÇ®ÁöÑÊó∂ÂÄô‰∏éÂ≠óËäÇÂ∫èÊúâÂÖ≥„ÄÇ</li>
<li>ÂçïÂ£∞ÈÅìÔºöÈááÊ†∑Êï∞ÊçÆÊåâÊó∂Èó¥È°∫Â∫èÂ≠òÂÇ®ÔºàÊúâÊó∂‰πü‰ºöÈááÁî®LRLRÊñπÂºèÔºå‰ΩÜÂè¶‰∏Ä‰∏™Â£∞ÈÅìÊï∞ÊçÆ‰∏∫0Ôºâ„ÄÇ
<img src="imagesForNotes/Â£∞ÈÅì.png" alt =Â£∞ÈÅì ></li>
</ul>
</li>
<li>
<p>Â≠òÂÇ®Ê†ºÂºèÂàÜ‰∏∫<code>Packed</code>Âíå<code>Planner</code>‰∏§ÁßçÔºåÂØπ‰∫éÂèåÈÄöÈÅìÈü≥È¢ëÔºå<code>Packed</code>‰∏∫‰∏§‰∏™Â£∞ÈÅìÁöÑÊï∞ÊçÆ‰∫§ÈîôÂ≠òÂÇ®;<code>Planner</code>‰∏∫‰∏§‰∏™Â£∞ÈÅìÁöÑÊï∞ÊçÆÂàÜÂºÄÂ≠òÂÇ®„ÄÇ</p>
<ul>
<li><code>Packed</code>ÔºöLRLRLR</li>
<li><code>Planner</code>ÔºöLLLRRR</li>
</ul>
</li>
<li>
<p>ffmpegÈü≥È¢ëËß£Á†ÅÂêéÁöÑÊï∞ÊçÆÂ≠òÊîæÂú®AVFrameÁªìÊûÑ‰Ωì‰∏≠Ôºö</p>
<ul>
<li>PackedÊ†ºÂºè‰∏ãÔºåframe.data[0]Â≠òÊîæÊâÄÊúâÂ£∞ÈÅìÁöÑÊï∞ÊçÆ„ÄÇ</li>
<li>PlannerÊ†ºÂºè‰∏ãÔºåframe.data[i]Â≠òÊîæÁ¨¨i‰∏™Â£∞ÈÅìÁöÑÊï∞ÊçÆ„ÄÇ</li>
<li>Â∑¶Â£∞ÈÅìdata[0]:LLLL&hellip;</li>
<li>Âè≥Â£∞ÈÅìdata[1]:RRRR&hellip;</li>
</ul>
</li>
<li>
<p>PlannerÊ®°ÂºèÊòØffmpegÂÜÖÈÉ®Â≠òÂÇ®Ê®°ÂºèÔºåÂÆûÈôÖ‰ΩøÁî®ÁöÑÈü≥È¢ëÊñá‰ª∂ÈÉΩÊòØPackedÊ®°Âºè„ÄÇ</p>
</li>
</ul>
<h4 id="pcmËÆ°ÁÆó">PCMËÆ°ÁÆó
</h4><ul>
<li>Â§ßÂ∞èËÆ°ÁÆóÔºö‰ª•CDÁöÑÈü≥Ë¥®‰∏∫‰æãÔºöÈáèÂåñÊ†ºÂºè‰∏∫16ÊØîÁâπÔºà2Â≠óËäÇÔºâÔºåÈááÊ†∑Áéá‰∏∫44100ÔºåÂ£∞ÈÅìÊï∞‰∏∫2„ÄÇ
<ul>
<li>ÊØîÁâπÁéá‰∏∫Ôºö16 * 44100 * 2 = 1378.125 kbps</li>
<li>ÊØèÁßíÂ≠òÂÇ®Á©∫Èó¥Ôºö1378.125 * 60/8/1024 = 10.09MB</li>
</ul>
</li>
<li>ffmpegÊèêÂèñpcmÊï∞ÊçÆÂëΩ‰ª§Ôºö</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">    ffmpeg -i input.aac -ar <span class="m">48000</span> -ac <span class="m">2</span> -f s16le output.pcm
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>ffplayÊí≠ÊîæpcmÊï∞ÊçÆÂëΩ‰ª§Ôºö</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">    ffplay -ar <span class="m">48000</span> -ac <span class="m">2</span> -f s16le output.pcm
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÈÄöËøá‰∏äËø∞Êåá‰ª§Êí≠Êîæ‰∏çÊàêÂäüÁöÑËØùÔºåÂèØ‰ª•Â∞ùËØïËΩ¨Êç¢PCMÊñá‰ª∂</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffmpeg -f s16le -ar <span class="m">48000</span> -ac <span class="m">2</span> -i output.pcm output_stereo.wav
</span></span><span class="line"><span class="cl">ffplay output_stereo.wav
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ÊµÅÁ®ã-8">ÊµÅÁ®ã
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>ÂáΩÊï∞Âêç</th>
          <th>ÊèèËø∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>avformat_open_input()</code></td>
          <td>ÊâìÂºÄËæìÂÖ•Êñá‰ª∂ÊàñÊµÅÂπ∂ËØªÂèñÂ§¥ÈÉ®‰ø°ÊÅØ„ÄÇ</td>
      </tr>
      <tr>
          <td><code>avformat_find_stream_info()</code></td>
          <td>ËØªÂèñ‰∏Ä‰∫õÊï∞ÊçÆÂåÖ‰ª•Ëé∑ÂèñÊµÅ‰ø°ÊÅØ„ÄÇ</td>
      </tr>
      <tr>
          <td><code>av_find_best_stream()</code></td>
          <td>Êü•ÊâæÊúÄ‰Ω≥ÊµÅÔºàÈü≥È¢ë„ÄÅËßÜÈ¢ëÊàñÂ≠óÂπïÔºâ„ÄÇ</td>
      </tr>
      <tr>
          <td><code>avcodec_alloc_context3()</code></td>
          <td>ÂàÜÈÖçËß£Á†ÅÂô®‰∏ä‰∏ãÊñá„ÄÇ</td>
      </tr>
      <tr>
          <td><code>avcodec_parameters_to_context()</code></td>
          <td>Â∞ÜÊµÅÂèÇÊï∞Â§çÂà∂Âà∞Ëß£Á†ÅÂô®‰∏ä‰∏ãÊñá‰∏≠„ÄÇ</td>
      </tr>
      <tr>
          <td><code>avcodec_find_decoder()</code></td>
          <td>Êü•ÊâæÂêàÈÄÇÁöÑËß£Á†ÅÂô®„ÄÇ</td>
      </tr>
      <tr>
          <td><code>avcodec_open2()</code></td>
          <td>ÊâìÂºÄËß£Á†ÅÂô®„ÄÇ</td>
      </tr>
      <tr>
          <td><code>av_frame_alloc()</code></td>
          <td>ÂàÜÈÖçAVFrameÁªìÊûÑ‰Ωì„ÄÇ</td>
      </tr>
      <tr>
          <td><code>av_samples_get_buffer_size()</code></td>
          <td>ËÆ°ÁÆóÈü≥È¢ëÁºìÂÜ≤Âå∫ÁöÑÂ§ßÂ∞è„ÄÇ</td>
      </tr>
      <tr>
          <td><code>avcodec_fill_audio_frame()</code></td>
          <td>Â°´ÂÖÖÈü≥È¢ëÂ∏ßÁöÑÁºìÂÜ≤Âå∫„ÄÇ</td>
      </tr>
      <tr>
          <td><code>av_read_frame()</code></td>
          <td>‰ªéËæìÂÖ•Êñá‰ª∂ÊàñÊµÅ‰∏≠ËØªÂèñÊï∞ÊçÆÂåÖ„ÄÇ</td>
      </tr>
      <tr>
          <td><code>avcodec_send_packet()</code></td>
          <td>Â∞ÜÊï∞ÊçÆÂåÖÂèëÈÄÅÂà∞Ëß£Á†ÅÂô®ËøõË°åËß£Á†Å„ÄÇ</td>
      </tr>
      <tr>
          <td><code>avcodec_receive_frame()</code></td>
          <td>‰ªéËß£Á†ÅÂô®Êé•Êî∂Ëß£Á†ÅÂêéÁöÑÂ∏ß„ÄÇ</td>
      </tr>
  </tbody>
</table></div>
<h3 id="‰ª£Á†Å-9">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavcodec/avcodec.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavformat/avformat.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/avutil.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavcodec/codec.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavcodec/packet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">decodeAudio</span><span class="p">(</span><span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_send_packet</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;send packet to decoder failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_receive_frame</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">AVERROR_EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;decode packet failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">dataSize</span> <span class="o">=</span> <span class="nf">av_get_bytes_per_sample</span><span class="p">(</span><span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">sample_fmt</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">dataSize</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;get bytes per sample failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// frame fltp 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">            data[0] L L L L
</span></span></span><span class="line"><span class="cl"><span class="cm">            data[1] R R R R
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">            --&gt; L R L R L R L R
</span></span></span><span class="line"><span class="cl"><span class="cm">        */</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">nb_samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">ch_layout</span><span class="p">.</span><span class="n">nb_channels</span><span class="p">;</span> <span class="n">channel</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fwrite</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+</span> <span class="n">dataSize</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_DEBUG</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage: %s &lt;input&gt; &lt;output&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">inFileName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open %s failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">inFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_find_stream_info</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find stream error:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_find_best_stream</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">AVMEDIA_TYPE_AUDIO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find best stream error:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">audioStreamIndex</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">decoderCtx</span> <span class="o">=</span> <span class="nf">avcodec_alloc_context3</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">decoderCtx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;alloc codec context failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_parameters_to_context</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">audioStreamIndex</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">AVCodec</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="nf">avcodec_find_decoder</span><span class="p">(</span><span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">codec_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">decoder</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find decoder %d failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">codec_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_open2</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open decoder error:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="s">&#34;wb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open %s failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">frameSize</span> <span class="o">=</span> <span class="nf">av_samples_get_buffer_size</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">ch_layout</span><span class="p">.</span><span class="n">nb_channels</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">nb_samples</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">sample_fmt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">frameBuffer</span> <span class="o">=</span> <span class="nf">av_malloc</span><span class="p">(</span><span class="n">frameSize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">avcodec_fill_audio_frame</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">ch_layout</span><span class="p">.</span><span class="n">nb_channels</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">sample_fmt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">frameBuffer</span><span class="p">,</span> <span class="n">frameSize</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nf">av_read_frame</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">audioStreamIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">decodeAudio</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">decodeAudio</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">fail</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inFmtCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">decoderCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avcodec_free_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoderCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">frameBuffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_freep</span><span class="p">(</span><span class="n">frameBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøêË°åÊåá‰ª§</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./demoBin ../video/test.aac ../video/test_decode_by_code.pcm 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ffmpeg -f f32le -ar <span class="m">44100</span> -ac <span class="m">2</span> -i ../video/test_decode_by_code.pcm ../video/test_decode_by_code_stereo.wav
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ffplay ../video/test_decode_by_code_stereo.wav 
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="Èü≥È¢ëÁºñÁ†Å">Èü≥È¢ëÁºñÁ†Å
</h2><h3 id="ÊµÅÁ®ã-9">ÊµÅÁ®ã
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>ÂáΩÊï∞Âêç</th>
          <th>ÊèèËø∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>av_frame_alloc</code></td>
          <td>ÂàÜÈÖç‰∏Ä‰∏™AVFrameÁªìÊûÑ‰Ωì</td>
      </tr>
      <tr>
          <td><code>av_frame_get_buffer</code></td>
          <td>‰∏∫AVFrameÂàÜÈÖçÁºìÂÜ≤Âå∫</td>
      </tr>
      <tr>
          <td><code>avcodec_find_encoder_by_name</code></td>
          <td>Ê†πÊçÆÂêçÁß∞Êü•ÊâæÁºñÁ†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>avcodec_alloc_context3</code></td>
          <td>ÂàÜÈÖçÁºñÁ†ÅÂô®‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>avcodec_open2</code></td>
          <td>ÊâìÂºÄÁºñÁ†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>avcodec_send_frame</code></td>
          <td>ÂèëÈÄÅÂ∏ßÂà∞ÁºñÁ†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>avcodec_receive_packet</code></td>
          <td>‰ªéÁºñÁ†ÅÂô®Êé•Êî∂ÁºñÁ†ÅÂêéÁöÑÊï∞ÊçÆÂåÖ</td>
      </tr>
  </tbody>
</table></div>
<p>ËøêË°åÊåá‰ª§</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffmpeg -ac <span class="m">2</span> -ar <span class="m">44100</span> -f s16le -i test.pcm -acodec libfdk_aac test1.aac
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ffplay test1.aac
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="‰ª£Á†Å-10">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavcodec/avcodec.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/avutil.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavcodec/codec.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavcodec/packet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/channel_layout.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/error.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/log.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/frame.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/samplefmt.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">encodeAudio</span><span class="p">(</span><span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_send_frame</span><span class="p">(</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;send frame to encoder failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_receive_packet</span><span class="p">(</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="nf">AVERROR</span><span class="p">(</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">AVERROR_EOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;receive packet from encoder failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fwrite</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_INFO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage: %s &lt;input file&gt; &lt;output file&gt;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">inFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Could not allocate video frame</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËøôÈáå‰ª£Á†ÅÊúâ‰∫õ‰∏çÂêå
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">frame</span><span class="o">-&gt;</span><span class="n">ch_layout</span><span class="p">.</span><span class="n">nb_channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_channel_layout_from_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">ch_layout</span><span class="p">,</span> <span class="n">AV_CH_LAYOUT_STEREO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">frame</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">AV_SAMPLE_FMT_S16</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">frame</span><span class="o">-&gt;</span><span class="n">nb_samples</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">av_frame_get_buffer</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">AVCodec</span> <span class="o">*</span><span class="n">encoder</span> <span class="o">=</span> <span class="nf">avcodec_find_encoder_by_name</span><span class="p">(</span><span class="s">&#34;libfdk_aac&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encoder</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find encoder failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">encoderCtx</span> <span class="o">=</span> <span class="nf">avcodec_alloc_context3</span><span class="p">(</span><span class="n">encoder</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">encoderCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;alloc encoder context failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">sample_fmt</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">ch_layout</span><span class="p">.</span><span class="n">nb_channels</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">ch_layout</span><span class="p">.</span><span class="n">nb_channels</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">encoderCtx</span><span class="o">-&gt;</span><span class="n">ch_layout</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">ch_layout</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_open2</span><span class="p">(</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">AV_LOG_ERROR</span><span class="p">,</span><span class="s">&#34;open encoder failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">src_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">inFileName</span><span class="p">,</span> <span class="s">&#34;rb&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">src_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open input file failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="s">&#34;wb+&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">src_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open output file failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">readSize</span> <span class="o">=</span> <span class="nf">fread</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">readSize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;finish read infile</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">encodeAudio</span><span class="p">(</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">encodeAudio</span><span class="p">(</span><span class="n">encoderCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">encoderCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avcodec_free_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encoderCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">src_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">src_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Êåá‰ª§</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">./demoBin test.pcm  aac_by_code.aac
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ffplay aac_by_code.aac
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ËßÜÈ¢ëÈááÈõÜ">ËßÜÈ¢ëÈááÈõÜ
</h2><h3 id="ËßÜÈ¢ëÈááÈõÜÂëΩ‰ª§">ËßÜÈ¢ëÈááÈõÜÂëΩ‰ª§
</h3><ul>
<li>Êü•ÁúãËÆæÂ§áÂàóË°®Ôºö</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffmpeg -hide_banner -devices
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/post/video_base/%E8%AE%BE%E5%A4%87%E5%88%97%E8%A1%A8.png"
	width="752"
	height="229"
	
	loading="lazy"
	
		alt="ËÆæÂ§áÂàóË°®"
	
	
		class="gallery-image" 
		data-flex-grow="328"
		data-flex-basis="788px"
	
></p>
<ul>
<li>Êü•ÁúãdshowÊîØÊåÅÁöÑÂèÇÊï∞Ôºö</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffmpeg -h <span class="nv">demuxer</span><span class="o">=</span>dshow
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Êü•ÁúãdshowÊîØÊåÅÁöÑËÆæÂ§áÔºö</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffmpeg -f dshow -list_devices <span class="nb">true</span> -i dummy
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰∏ÄËà¨ÊòØ<code>Integrated Camera</code>ÔºåËøôÊòØÊú¨Âú∞ÊëÑÂÉèÂ§¥</p>
<ul>
<li>ÈááÈõÜÊëÑÂÉèÂ§¥ÁîªÈù¢Ôºö</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffmpeg -f dshow -i <span class="nv">video</span><span class="o">=</span><span class="s2">&#34;Integrated Camera&#34;</span> ./video/output.mp4
</span></span></code></pre></td></tr></table>
</div>
</div><p>Êí≠ÊîæÊëÑÂÉèÂ§¥ÈááÈõÜÁîªÈù¢Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffplay output.mp4
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ÊµÅÁ®ã-10">ÊµÅÁ®ã
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>ÂáΩÊï∞Âêç</th>
          <th>ÊèèËø∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>avdevice_register_all</code></td>
          <td>Ê≥®ÂÜåÊâÄÊúâÂèØÁî®ÁöÑËÆæÂ§á</td>
      </tr>
      <tr>
          <td><code>avformat_alloc_context</code></td>
          <td>ÂàÜÈÖçÊ†ºÂºè‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>av_dict_set</code></td>
          <td>ËÆæÁΩÆÂ≠óÂÖ∏ÈÄâÈ°π</td>
      </tr>
      <tr>
          <td><code>av_find_input_format</code></td>
          <td>Êü•ÊâæËæìÂÖ•Ê†ºÂºè</td>
      </tr>
      <tr>
          <td><code>avformat_open_input</code></td>
          <td>ÊâìÂºÄËæìÂÖ•Êñá‰ª∂</td>
      </tr>
      <tr>
          <td><code>avformat_find_stream_info</code></td>
          <td>Êü•ÊâæÊµÅ‰ø°ÊÅØ</td>
      </tr>
      <tr>
          <td><code>av_find_best_stream</code></td>
          <td>Êü•ÊâæÊúÄ‰Ω≥ÊµÅ</td>
      </tr>
      <tr>
          <td><code>avcodec_alloc_context3</code></td>
          <td>ÂàÜÈÖçÁºñËß£Á†ÅÂô®‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>avcode_parameters_to_context</code></td>
          <td>Â∞ÜÂèÇÊï∞Â§çÂà∂Âà∞‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>avcodec_find_decoder</code></td>
          <td>Êü•ÊâæËß£Á†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>avcodec_open2</code></td>
          <td>ÊâìÂºÄÁºñËß£Á†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>av_read_frame</code></td>
          <td>ËØªÂèñÂ∏ß</td>
      </tr>
      <tr>
          <td><code>avcode_send_packet</code></td>
          <td>ÂèëÈÄÅÊï∞ÊçÆÂåÖ</td>
      </tr>
      <tr>
          <td><code>avcodec_receive_frame</code></td>
          <td>Êé•Êî∂Â∏ß</td>
      </tr>
  </tbody>
</table></div>
<p>È¢úËâ≤Á©∫Èó¥Ê†ºÂºèËΩ¨Êç¢Ôºö</p>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>ÂáΩÊï∞Âêç</th>
          <th>ÊèèËø∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>sws_getContext</code></td>
          <td>Ëé∑ÂèñÁº©Êîæ‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>av_frame_alloc</code></td>
          <td>ÂàÜÈÖçÂ∏ß</td>
      </tr>
      <tr>
          <td><code>av_image_get_buffer_size</code></td>
          <td>Ëé∑ÂèñÂõæÂÉèÁºìÂÜ≤Âå∫Â§ßÂ∞è</td>
      </tr>
      <tr>
          <td><code>av_malloc</code></td>
          <td>ÂàÜÈÖçÂÜÖÂ≠ò</td>
      </tr>
      <tr>
          <td><code>av_image_fill_arrays</code></td>
          <td>Â°´ÂÖÖÂõæÂÉèÊï∞ÁªÑ</td>
      </tr>
      <tr>
          <td><code>sws_scale</code></td>
          <td>Áº©ÊîæÂõæÂÉè</td>
      </tr>
  </tbody>
</table></div>
<p>ÂÖàÁî®ffmpegÊåá‰ª§ËØï‰∏Ä‰∏ãËßÜÈ¢ëÈááÈõÜÊ†ºÂºèÔºåÂêéÁª≠‰ª£Á†ÅÂÜôÁöÑÊó∂ÂÄôË¶ÅÁî®ÂØπÂ∫îÈááÈõÜÁöÑÊ†ºÂºè„ÄÇ</p>
<h3 id="‰ª£Á†Å-11">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavcodec/avcodec.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavdevice/avdevice.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavformat/avformat.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/avutil.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/imgutils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libswscale/swscale.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavcodec/packet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/dict.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/frame.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/log.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// ÊòæÁ§∫ÂèØÁî®ÁöÑÊëÑÂÉèÂ§¥ËÆæÂ§á
</span></span></span><span class="line"><span class="cl"><span class="c1">// ffmpeg -f dshow -list_devices true -i dummy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">dshowListDevices</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">AVInputFormat</span> <span class="o">*</span><span class="n">inFmt</span> <span class="o">=</span> <span class="nf">av_find_input_format</span><span class="p">(</span><span class="s">&#34;dshow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inFmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find dshow failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆÂèÇÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVDictionary</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_dict_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&#34;list_devices&#34;</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nf">avformat_alloc_context</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Á¨¨‰∫å‰∏™ÂèÇÊï∞ÊòØURL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="s">&#34;video=Integrated Camera&#34;</span><span class="p">,</span> <span class="n">inFmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open input format failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inFmtCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_free_context</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">decodeVideo</span><span class="p">(</span><span class="k">struct</span> <span class="n">SwsContext</span> <span class="o">*</span><span class="n">swsCtx</span><span class="p">,</span> <span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">AVFrame</span> <span class="o">*</span><span class="n">destFrame</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">avcodec_send_packet</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="nf">avcodec_receive_frame</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">sws_scale</span><span class="p">(</span><span class="n">swsCtx</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="p">)</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fwrite</span><span class="p">(</span><span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fwrite</span><span class="p">(</span><span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fwrite</span><span class="p">(</span><span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_INFO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage:%s &lt;outFileName&gt; </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">avdevice_register_all</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dshowListDevices</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nf">avformat_alloc_context</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">AVInputFormat</span> <span class="o">*</span><span class="n">inFmt</span> <span class="o">=</span> <span class="nf">av_find_input_format</span><span class="p">(</span><span class="s">&#34;dshow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inFmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open input format failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVDictionary</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_dict_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&#34;framerate&#34;</span><span class="p">,</span> <span class="s">&#34;30&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="s">&#34;video=Integrated Camera&#34;</span><span class="p">,</span> <span class="n">inFmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open input failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_find_stream_info</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find stream info failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_find_best_stream</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">AVMEDIA_TYPE_VIDEO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find best stream failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">videoIndex</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàõÂª∫Ëß£Á†ÅÂô®‰∏ä‰∏ãÊñá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">decoderCtx</span> <span class="o">=</span> <span class="nf">avcodec_alloc_context3</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_parameters_to_context</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">videoIndex</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;copy parameters to context failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">AVCodec</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="nf">avcodec_find_decoder</span><span class="p">(</span><span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">codec_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">decoder</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find decoder failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_open2</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open decoder failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFrame</span> <span class="o">*</span><span class="n">destFrame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">enum</span> <span class="n">AVPixelFormat</span> <span class="n">destPixFmt</span> <span class="o">=</span> <span class="n">AV_PIX_FMT_YUV420P</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">outBuffer</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_malloc</span><span class="p">(</span><span class="nf">av_image_get_buffer_size</span><span class="p">(</span><span class="n">destPixFmt</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_image_fill_arrays</span><span class="p">(</span><span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">destFrame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">,</span> <span class="n">outBuffer</span><span class="p">,</span> <span class="n">destPixFmt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                         <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">SwsContext</span> <span class="o">*</span><span class="n">swsCtx</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sws_getContext</span><span class="p">(</span><span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">coded_width</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">coded_height</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">pix_fmt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                       <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">destPixFmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">swsCtx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;create sws context failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="s">&#34;wb+&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open out put file %s failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">av_read_frame</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">videoIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">decodeVideo</span><span class="p">(</span><span class="n">swsCtx</span><span class="p">,</span> <span class="n">decoderCtx</span><span class="p">,</span> <span class="n">destFrame</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">decodeVideo</span><span class="p">(</span><span class="n">swsCtx</span><span class="p">,</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">destFrame</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inFmtCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_free_context</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">decoderCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avcodec_free_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoderCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">outBuffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_freep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">outBuffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="Èü≥È¢ëÈááÈõÜ">Èü≥È¢ëÈááÈõÜ
</h2><h3 id="Èü≥È¢ëÈááÈõÜÂëΩ‰ª§">Èü≥È¢ëÈááÈõÜÂëΩ‰ª§
</h3><p>ÈááÈõÜÈ∫¶ÂÖãÈ£éÂ£∞Èü≥Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffmpeg -f dshow -i <span class="nv">audio</span><span class="o">=</span><span class="s2">&#34;ÈòµÂàóÈ∫¶ÂÖãÈ£é (AMD Audio Device)&#34;</span> -ar <span class="m">44100</span> -f f32le output.pcm
</span></span></code></pre></td></tr></table>
</div>
</div><p>Êí≠ÊîæÈ∫¶ÂÖãÈ£éÈááÈõÜÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffplay -ar <span class="m">44100</span> -f f32le output.pcm
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ÊµÅÁ®ã-11">ÊµÅÁ®ã
</h3><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th>ÂáΩÊï∞Âêç</th>
          <th>ÊèèËø∞</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>avdevice_register_all</code></td>
          <td>Ê≥®ÂÜåÊâÄÊúâÂèØÁî®ÁöÑËÆæÂ§á</td>
      </tr>
      <tr>
          <td><code>avformat_alloc_context</code></td>
          <td>ÂàÜÈÖçÊ†ºÂºè‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>av_dict_set</code></td>
          <td>ËÆæÁΩÆÂ≠óÂÖ∏ÈÄâÈ°π</td>
      </tr>
      <tr>
          <td><code>av_find_input_format</code></td>
          <td>Êü•ÊâæËæìÂÖ•Ê†ºÂºè</td>
      </tr>
      <tr>
          <td><code>avformat_open_input</code></td>
          <td>ÊâìÂºÄËæìÂÖ•Êñá‰ª∂</td>
      </tr>
      <tr>
          <td><code>avformat_find_stream_info</code></td>
          <td>Êü•ÊâæÊµÅ‰ø°ÊÅØ</td>
      </tr>
      <tr>
          <td><code>av_find_best_stream</code></td>
          <td>Êü•ÊâæÊúÄ‰Ω≥ÊµÅ</td>
      </tr>
      <tr>
          <td><code>avcodec_alloc_context3</code></td>
          <td>ÂàÜÈÖçÁºñËß£Á†ÅÂô®‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>avcode_parameters_to_context</code></td>
          <td>Â∞ÜÂèÇÊï∞Â§çÂà∂Âà∞‰∏ä‰∏ãÊñá</td>
      </tr>
      <tr>
          <td><code>avcodec_find_decoder</code></td>
          <td>Êü•ÊâæËß£Á†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>avcodec_open2</code></td>
          <td>ÊâìÂºÄÁºñËß£Á†ÅÂô®</td>
      </tr>
      <tr>
          <td><code>av_read_frame</code></td>
          <td>ËØªÂèñÂ∏ß</td>
      </tr>
      <tr>
          <td><code>avcode_send_packet</code></td>
          <td>ÂèëÈÄÅÊï∞ÊçÆÂåÖ</td>
      </tr>
      <tr>
          <td><code>avcodec_receive_frame</code></td>
          <td>Êé•Êî∂Â∏ß</td>
      </tr>
  </tbody>
</table></div>
<h3 id="‰ª£Á†Å-12">‰ª£Á†Å
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavcodec/avcodec.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavdevice/avdevice.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavformat/avformat.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/avutil.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libavutil/imgutils.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;libswscale/swscale.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavcodec/packet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/dict.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/frame.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;libavutil/log.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;time.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="c1">// ÊòæÁ§∫ÂèØÁî®ÁöÑÊëÑÂÉèÂ§¥ËÆæÂ§á
</span></span></span><span class="line"><span class="cl"><span class="c1">// ffmpeg -f dshow -list_devices true -i dummy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">dshowListDevices</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">AVInputFormat</span> <span class="o">*</span><span class="n">inFmt</span> <span class="o">=</span> <span class="nf">av_find_input_format</span><span class="p">(</span><span class="s">&#34;dshow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inFmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find dshow failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆÂèÇÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVDictionary</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_dict_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">options</span><span class="p">,</span> <span class="s">&#34;list_devices&#34;</span><span class="p">,</span> <span class="s">&#34;true&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nf">avformat_alloc_context</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Á¨¨‰∫å‰∏™ÂèÇÊï∞ÊòØURL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="s">&#34;video=Integrated Camera&#34;</span><span class="p">,</span> <span class="n">inFmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open input format failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inFmtCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_close_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_free_context</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">decodeAudio</span><span class="p">(</span><span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">avcodec_send_packet</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">AVFrame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nf">av_frame_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="nf">avcodec_receive_frame</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fwrite</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">linesize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_frame_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">av_log_set_level</span><span class="p">(</span><span class="n">AV_LOG_INFO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;Usage:%s &lt;outFileName&gt; </span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outFileName</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nf">avdevice_register_all</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dshowListDevices</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVFormatContext</span> <span class="o">*</span><span class="n">inFmtCtx</span> <span class="o">=</span> <span class="nf">avformat_alloc_context</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">AVInputFormat</span> <span class="o">*</span><span class="n">inFmt</span> <span class="o">=</span> <span class="nf">av_find_input_format</span><span class="p">(</span><span class="s">&#34;dshow&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inFmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open input format failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">AVDictionary</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// av_dict_set(&amp;options, &#34;framerate&#34;, &#34;30&#34;, 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_open_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="s">&#34;audio=ÈòµÂàóÈ∫¶ÂÖãÈ£é (AMD Audio Device)&#34;</span><span class="p">,</span> <span class="n">inFmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open input failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avformat_find_stream_info</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find stream info failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">av_find_best_stream</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">AVMEDIA_TYPE_AUDIO</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find best stream failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">audioIndex</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàõÂª∫Ëß£Á†ÅÂô®‰∏ä‰∏ãÊñá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">AVCodecContext</span> <span class="o">*</span><span class="n">decoderCtx</span> <span class="o">=</span> <span class="nf">avcodec_alloc_context3</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_parameters_to_context</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">inFmtCtx</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">audioIndex</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">codecpar</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;copy parameters to context failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="n">AVCodec</span> <span class="o">*</span><span class="n">decoder</span> <span class="o">=</span> <span class="nf">avcodec_find_decoder</span><span class="p">(</span><span class="n">decoderCtx</span><span class="o">-&gt;</span><span class="n">codec_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">decoder</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;find decoder failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ret</span> <span class="o">=</span> <span class="nf">avcodec_open2</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open decoder failed:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">av_err2str</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#if 0</span><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">    AVFrame *destFrame = av_frame_alloc();
</span></span></span><span class="line"><span class="cl"><span class="c">    enum AVPixelFormat destPixFmt = AV_PIX_FMT_YUV420P;
</span></span></span><span class="line"><span class="cl"><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">    uint8_t *outBuffer =
</span></span></span><span class="line"><span class="cl"><span class="c">        av_malloc(av_image_get_buffer_size(destPixFmt, decoderCtx-&gt;width, decoderCtx-&gt;height, 1));
</span></span></span><span class="line"><span class="cl"><span class="c">    av_image_fill_arrays(destFrame-&gt;data, destFrame-&gt;linesize, outBuffer, destPixFmt,
</span></span></span><span class="line"><span class="cl"><span class="c">                         decoderCtx-&gt;width, decoderCtx-&gt;height, 1);
</span></span></span><span class="line"><span class="cl"><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">    struct SwsContext *swsCtx =
</span></span></span><span class="line"><span class="cl"><span class="c">        sws_getContext(decoderCtx-&gt;coded_width, decoderCtx-&gt;coded_height, decoderCtx-&gt;pix_fmt,
</span></span></span><span class="line"><span class="cl"><span class="c">                       decoderCtx-&gt;width, decoderCtx-&gt;height, destPixFmt, 0, NULL, NULL, NULL);
</span></span></span><span class="line"><span class="cl"><span class="c">    if (swsCtx == NULL)
</span></span></span><span class="line"><span class="cl"><span class="c">    {
</span></span></span><span class="line"><span class="cl"><span class="c">        av_log(NULL, AV_LOG_ERROR, &#34;create sws context failed!\n&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c">        ret = -1;
</span></span></span><span class="line"><span class="cl"><span class="c">        goto end;
</span></span></span><span class="line"><span class="cl"><span class="c">    }
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">dest_fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="s">&#34;wb+&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_log</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">AV_LOG_ERROR</span><span class="p">,</span> <span class="s">&#34;open out put file %s failed!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">AVPacket</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nf">av_packet_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">av_read_frame</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">stream_index</span> <span class="o">==</span> <span class="n">audioIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// decodeVideo(swsCtx, decoderCtx, destFrame, packet, dest_fp);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nf">decodeAudio</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">av_packet_unref</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// decodeVideo(swsCtx, decoderCtx, destFrame, NULL, dest_fp);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">decodeAudio</span><span class="p">(</span><span class="n">decoderCtx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inFmtCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avformat_free_context</span><span class="p">(</span><span class="n">inFmtCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">decoderCtx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">avcodec_free_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decoderCtx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dest_fp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">dest_fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÈááÈõÜÂÆåÂêéË¶ÅÁî®Êåá‰ª§</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ffplay -f s16le -ar <span class="m">44100</span> code.pcm 
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÊâçÂèØ‰ª•Êí≠ÊîæÔºåÂèØËÉΩÊòØÂèÇÊï∞ÁöÑ‰∏çÂêå</p>

</section>


    <footer class="article-footer">
    

    
</footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Áõ∏ÂÖ≥ÊñáÁ´†</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/post/leixiaohua-note/">
        
        
            <div class="article-image">
                <img src="/post/leixiaohua-note/cover.26c6bb1e5c3c89a60ddf413fcb42b8ed.jpg" 
                        width="4608" 
                        height="3456" 
                        loading="lazy"
                        alt="Featured image of post Èõ∑ÈúÑÈ™ÖËØæÁ®ãÁ¨îËÆ∞"
                        data-key="leixiaohua-note" 
                        data-hash="md5-Jsa7Hlw8iaYN30E/y0K47Q==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Èõ∑ÈúÑÈ™ÖËØæÁ®ãÁ¨îËÆ∞</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="serenNan/serenNan.github.io"
    data-repo-id="R_kgDONieGHg"
    data-category="Announcements"
    data-category-id="DIC_kwDONieGHs4ClphA"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="light"
    data-lang="zh-CN"
    data-loading=""
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('dark');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 serenNan
    </section>
    
    <section class="powerby">
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
<style>
  @font-face {
    font-family: 'MapleMono2';
    src: url('https://example.com/font/MapleMono2.ttf') format('truetype');
  }

  :root {
    --base-font-family: 'MapleMono2';
    --code-font-family: 'MapleMono2';
  }
</style>

<script src="https://npm.elemecdn.com/nprogress@0.2.0/nprogress.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://npm.elemecdn.com/nprogress@0.2.0/nprogress.css" crossorigin="anonymous" />
<script>
    NProgress.start();
    document.addEventListener("readystatechange", () => {
        if (document.readyState === "interactive") NProgress.inc(0.8);
        if (document.readyState === "complete") NProgress.done();
    });
</script>



<div id="particles-js"></div>
<script src="/background/particles.min.js"></script>
<script>
particlesJS.load('particles-js', '\/background\/particlesjs-config.json', function() {
console.log('particles.js loaded - callback');
});
</script>


<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
  }
</style>





<style>
    #backTopBtn {
        display: none;
        position: fixed;
        bottom: 5%;
        right: 24%;  
        z-index: 99;
        cursor: pointer;
        width: 30px;
        height: 30px;
        background-image: url('/icons/backTop.svg');  
        background-size: cover;  
    }
</style>

<script>
    

    function initScrollTop() {
        let rightSideBar = document.querySelector(".right-sidebar");
        if (!rightSideBar) {
            return;
        }
        
        let btn = document.createElement("div");
        btn.id = "backTopBtn";
        btn.onclick = backToTop;
        rightSideBar.appendChild(btn);
        
        window.onscroll = function() {
            
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                btn.style.display = "block";
            } else {
                btn.style.display = "none";
            }
        };
    }

    

    function backToTop(){
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    initScrollTop();
</script>

<style>
    .highlight {
         
        max-height: 400px;
        overflow: hidden;
    }

    .code-show {
        max-height: none !important;
    }

    .code-more-box {
        width: 100%;
        padding-top: 78px;
        background-image: -webkit-gradient(linear, left top, left bottom, from(rgba(255, 255, 255, 0)), to(#fff));
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    .code-more-btn {
        display: block;
        margin: auto;
        width: 44px;
        height: 25px;
        background: #313535;
        border-top-left-radius: 16px;
        border-top-right-radius: 16px;
        padding-top: 6px;
        cursor: pointer;
    }

    .code-more-img {
        cursor: pointer !important;
        display: block;
        margin: auto;
        width: 22px;
        height: 16px;
    }
</style>

<script>
  function initCodeMoreBox() {
    let codeBlocks = document.querySelectorAll(".highlight");
    if (!codeBlocks) {
      return;
    }
    codeBlocks.forEach(codeBlock => {
      
      if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
        return;
      }
      
      
      let codeMoreBox = document.createElement('div');
      codeMoreBox.classList.add('code-more-box');
      
      let codeMoreBtn = document.createElement('span');
      codeMoreBtn.classList.add('code-more-btn');
      codeMoreBtn.addEventListener('click', () => {
        codeBlock.classList.add('code-show');
        codeMoreBox.style.display = 'none';
      })
      
      let img = document.createElement('img');
      img.classList.add('code-more-img');
      img.src = 'https:\/\/example.com\/img\/codeMore.png';

      
      codeMoreBtn.appendChild(img);
      codeMoreBox.appendChild(codeMoreBtn);
      codeBlock.appendChild(codeMoreBox)
    })
  }
  
  initCodeMoreBox();
</script>

    </body>
</html>
